<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="EduAgentX 项目面试话术指南 一、项目整体介绍（30秒版本） &ldquo;我做的是一个智能教育管理系统 EduAgentX，核心功能包括 AI 智能题目生成、高并发抢课系统 和 RAG 知识库检索。技术栈是 Spring Boot 3 + Spring AI + Redis + RocketMQ，同时我还完成了从单体到微服务的架构演进，使用 Spring Cloud Alibaba + Dubbo + Nacos + Higress 网关。项目中我重点解决了三个技术难题：抢课系统的高并发防超卖、AI 工作流的流式输出、以及 热点数据的缓存优化。&rdquo;\n">
<title>面试话术</title>

<link rel='canonical' href='https://LuciusWan.github.io/p/%E9%9D%A2%E8%AF%95%E8%AF%9D%E6%9C%AF/'>

<link rel="stylesheet" href="/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css"><meta property='og:title' content="面试话术">
<meta property='og:description' content="EduAgentX 项目面试话术指南 一、项目整体介绍（30秒版本） &ldquo;我做的是一个智能教育管理系统 EduAgentX，核心功能包括 AI 智能题目生成、高并发抢课系统 和 RAG 知识库检索。技术栈是 Spring Boot 3 + Spring AI + Redis + RocketMQ，同时我还完成了从单体到微服务的架构演进，使用 Spring Cloud Alibaba + Dubbo + Nacos + Higress 网关。项目中我重点解决了三个技术难题：抢课系统的高并发防超卖、AI 工作流的流式输出、以及 热点数据的缓存优化。&rdquo;\n">
<meta property='og:url' content='https://LuciusWan.github.io/p/%E9%9D%A2%E8%AF%95%E8%AF%9D%E6%9C%AF/'>
<meta property='og:site_name' content='LuciusWan'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-11-27T20:08:45&#43;08:00'/><meta property='article:modified_time' content='2025-11-27T20:08:45&#43;08:00'/>
<meta name="twitter:title" content="面试话术">
<meta name="twitter:description" content="EduAgentX 项目面试话术指南 一、项目整体介绍（30秒版本） &ldquo;我做的是一个智能教育管理系统 EduAgentX，核心功能包括 AI 智能题目生成、高并发抢课系统 和 RAG 知识库检索。技术栈是 Spring Boot 3 + Spring AI + Redis + RocketMQ，同时我还完成了从单体到微服务的架构演进，使用 Spring Cloud Alibaba + Dubbo + Nacos + Higress 网关。项目中我重点解决了三个技术难题：抢课系统的高并发防超卖、AI 工作流的流式输出、以及 热点数据的缓存优化。&rdquo;\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_9fb38d5acaa6ba70.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🎇</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">LuciusWan</a></h1>
            <h2 class="site-description">欢迎来到我的blog</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/440554295'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z" /><path d="M8 3l2 3" /><path d="M16 3l-2 3" /><path d="M9 13v-2" /><path d="M15 11v2" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/LuciusWan'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友情链接</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#一项目整体介绍30秒版本">一、项目整体介绍（30秒版本）</a></li>
    <li><a href="#零八股文融合速查表">零、八股文融合速查表</a></li>
    <li><a href="#遇到的问题与解决方式">遇到的问题与解决方式</a>
      <ol>
        <li><a href="#大纲生成">大纲生成</a></li>
        <li><a href="#题目生成">题目生成</a></li>
      </ol>
    </li>
    <li><a href="#抢课系统">抢课系统</a>
      <ol>
        <li>
          <ol>
            <li><a href="#第一部分针对高频变化的抢课库存-解决写压力--强一致性">第一部分：针对“高频变化的抢课库存” (解决写压力 &amp; 强一致性)</a></li>
            <li><a href="#第二部分针对低频变化的课程详情-解决读压力--最终一致性">第二部分：针对“低频变化的课程详情” (解决读压力 &amp; 最终一致性)</a></li>
            <li><a href="#第三部分细节优化-展示技术深度">第三部分：细节优化 (展示技术深度)</a></li>
          </ol>
        </li>
        <li><a href="#-预判面试官的追问-prepare-for-defense">💡 预判面试官的追问 (Prepare for Defense)</a></li>
        <li><a href="#q-抢课数据为什么不走本地缓存">Q: 抢课数据为什么不走本地缓存？</a></li>
        <li><a href="#q-课程详情为什么用续期策略">Q: 课程详情为什么用续期策略？</a></li>
        <li><a href="#q-多节点本地缓存怎么同步">Q: 多节点本地缓存怎么同步？</a></li>
        <li><a href="#q-缓存失效后大量请求同时查-redis-怎么办">Q: 缓存失效后大量请求同时查 Redis 怎么办？</a></li>
        <li><a href="#q-rocketmq-在你的系统中做了什么">Q: RocketMQ 在你的系统中做了什么？</a></li>
      </ol>
    </li>
    <li><a href="#eduagentx-项目面试问答文档">EduAgentX 项目面试问答文档</a></li>
    <li><a href="#目录">目录</a></li>
    <li><a href="#一redis技术细节">一、Redis技术细节</a>
      <ol>
        <li><a href="#11-redis序列化方式">1.1 Redis序列化方式</a></li>
        <li><a href="#12-lua脚本原子操作">1.2 Lua脚本原子操作</a></li>
        <li><a href="#13-多级缓存架构">1.3 多级缓存架构</a></li>
        <li><a href="#14-heavykeeper热key检测">1.4 HeavyKeeper热Key检测</a></li>
      </ol>
    </li>
    <li><a href="#二微服务架构">二、微服务架构</a>
      <ol>
        <li><a href="#21-dubbo配置与调用">2.1 Dubbo配置与调用</a></li>
        <li><a href="#22-服务拆分策略">2.2 服务拆分策略</a></li>
        <li><a href="#23-跨服务调用设计">2.3 跨服务调用设计</a></li>
        <li><a href="#24-分布式session">2.4 分布式Session</a></li>
        <li><a href="#25-dubbo底层原理深入">2.5 Dubbo底层原理深入</a></li>
        <li><a href="#26-dubbo高级特性">2.6 Dubbo高级特性</a></li>
      </ol>
    </li>
    <li><a href="#三高并发抢课系统">三、高并发抢课系统</a>
      <ol>
        <li><a href="#31-抢课核心流程">3.1 抢课核心流程</a></li>
        <li><a href="#32-数据一致性保证">3.2 数据一致性保证</a></li>
        <li><a href="#33-限流实现">3.3 限流实现</a></li>
        <li><a href="#34-性能优化措施">3.4 性能优化措施</a></li>
      </ol>
    </li>
    <li><a href="#四ai工作流系统">四、AI工作流系统</a>
      <ol>
        <li><a href="#41-langgraph4j工作流">4.1 LangGraph4j工作流</a></li>
        <li><a href="#42-设计模式应用">4.2 设计模式应用</a></li>
        <li><a href="#43-sse实时推送">4.3 SSE实时推送</a></li>
        <li><a href="#44-rag检索增强">4.4 RAG检索增强</a></li>
      </ol>
    </li>
    <li><a href="#五数据库与orm">五、数据库与ORM</a>
      <ol>
        <li><a href="#51-mybatis-flex使用">5.1 MyBatis-Flex使用</a></li>
        <li><a href="#52-批量操作优化">5.2 批量操作优化</a></li>
        <li><a href="#53-连接池配置">5.3 连接池配置</a></li>
        <li><a href="#54-事务管理">5.4 事务管理</a></li>
      </ol>
    </li>
    <li><a href="#六安全与认证">六、安全与认证</a>
      <ol>
        <li><a href="#61-密码加密">6.1 密码加密</a></li>
        <li><a href="#62-权限控制">6.2 权限控制</a></li>
      </ol>
    </li>
    <li><a href="#七rocketmq消息队列">七、RocketMQ消息队列</a>
      <ol>
        <li><a href="#71-mq选型对比">7.1 MQ选型对比</a></li>
        <li><a href="#72-生产者消费者配置">7.2 生产者/消费者配置</a></li>
      </ol>
    </li>
    <li><a href="#八阿里云oss文件存储">八、阿里云OSS文件存储</a>
      <ol>
        <li><a href="#81-oss配置">8.1 OSS配置</a></li>
        <li><a href="#82-文件上传流程">8.2 文件上传流程</a></li>
      </ol>
    </li>
    <li><a href="#九上线运维">九、上线运维</a>
      <ol>
        <li><a href="#91-多环境配置">9.1 多环境配置</a></li>
        <li><a href="#92-健康检查">9.2 健康检查</a></li>
        <li><a href="#93-缓存监控">9.3 缓存监控</a></li>
        <li><a href="#94-系统初始化">9.4 系统初始化</a></li>
      </ol>
    </li>
    <li><a href="#十异常处理与全局响应">十、异常处理与全局响应</a>
      <ol>
        <li><a href="#101-统一响应格式">10.1 统一响应格式</a></li>
        <li><a href="#102-全局异常处理">10.2 全局异常处理</a></li>
      </ol>
    </li>
    <li><a href="#十一技术栈选型">十一、技术栈选型</a>
      <ol>
        <li><a href="#111-核心版本">11.1 核心版本</a></li>
        <li><a href="#112-依赖选型原因">11.2 依赖选型原因</a></li>
      </ol>
    </li>
    <li><a href="#总结">总结</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E9%9D%A2%E8%AF%95%E8%AF%9D%E6%9C%AF/">面试话术</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-11-27</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 35 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="eduagentx-项目面试话术指南">EduAgentX 项目面试话术指南
</h1><h2 id="一项目整体介绍30秒版本">一、项目整体介绍（30秒版本）
</h2><blockquote>
<p>&ldquo;我做的是一个智能教育管理系统 EduAgentX，核心功能包括 <strong>AI 智能题目生成</strong>、<strong>高并发抢课系统</strong> 和 <strong>RAG 知识库检索</strong>。技术栈是 Spring Boot 3 + Spring AI + Redis + RocketMQ，同时我还完成了从单体到微服务的架构演进，使用 Spring Cloud Alibaba + Dubbo + Nacos + Higress 网关。项目中我重点解决了三个技术难题：<strong>抢课系统的高并发防超卖</strong>、<strong>AI 工作流的流式输出</strong>、以及 <strong>热点数据的缓存优化</strong>。&rdquo;</p>
</blockquote>
<hr>
<h2 id="零八股文融合速查表">零、八股文融合速查表
</h2><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>八股知识点</th>
          <th>项目中的应用场景</th>
          <th>引出话术</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Redis 单线程模型</strong></td>
          <td>Lua 脚本原子性</td>
          <td>&ldquo;Lua 能保证原子性是因为 Redis 单线程&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>Redis 数据结构</strong></td>
          <td>Hash 存储库存/抢课状态</td>
          <td>&ldquo;我用 Hash 而不是 String，因为&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>Redis 持久化</strong></td>
          <td>抢课数据可靠性</td>
          <td>&ldquo;我配置了 AOF 持久化，防止宕机丢数据&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>线程池参数</strong></td>
          <td>异步工作流执行</td>
          <td>&ldquo;我自定义了线程池，核心线程数设置为&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>CAS 与原子类</strong></td>
          <td>HeavyKeeper 计数器</td>
          <td>&ldquo;我用 AtomicInteger 保证计数的线程安全&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>ConcurrentHashMap</strong></td>
          <td>热点 Key 存储</td>
          <td>&ldquo;我用 ConcurrentHashMap 而不是 HashMap&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>阻塞队列</strong></td>
          <td>消息缓冲区</td>
          <td>&ldquo;我用 ConcurrentLinkedQueue 无锁队列&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>AOP 原理</strong></td>
          <td>限流切面、性能监控</td>
          <td>&ldquo;我用 AOP 实现了限流，原理是动态代理&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>Spring 事务</strong></td>
          <td>批量写入数据库</td>
          <td>&ldquo;我用 TransactionTemplate 编程式事务&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>MySQL 索引</strong></td>
          <td>抢课记录查询优化</td>
          <td>&ldquo;我给 student_id + subject_id 建了联合索引&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>MySQL 锁</strong></td>
          <td>纯 MySQL 抢课方案</td>
          <td>&ldquo;我还实现了一版用悲观锁的方案&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>消息队列</strong></td>
          <td>异步削峰</td>
          <td>&ldquo;我用 RocketMQ 实现异步，选它是因为&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>设计模式</strong></td>
          <td>题目生成模块</td>
          <td>&ldquo;我用了策略模式、模板方法、工厂模式&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>JVM 内存模型</strong></td>
          <td>ThreadLocal 存储 SSE</td>
          <td>&ldquo;我用 ThreadLocal 存储 Emitter，避免&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>序列化</strong></td>
          <td>Redis 序列化配置</td>
          <td>&ldquo;我配置了 Jackson 序列化，解决了&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>分布式锁</strong></td>
          <td>防止重复抢课</td>
          <td>&ldquo;除了 Lua，我还可以用 Redisson 分布式锁&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>CAP 理论</strong></td>
          <td>缓存一致性策略</td>
          <td>&ldquo;我选择了 AP，保证可用性，最终一致&hellip;&rdquo;</td>
      </tr>
      <tr>
          <td><strong>限流算法</strong></td>
          <td>滑动窗口限流</td>
          <td>&ldquo;我实现了滑动窗口限流，用 Redis ZSet&hellip;&rdquo;</td>
      </tr>
  </tbody>
</table></div>
<hr>
<h2 id="遇到的问题与解决方式">遇到的问题与解决方式
</h2><h3 id="大纲生成">大纲生成
</h3><p><strong>1. 背景 (Situation)</strong> “这个故事发生在我们的比赛决赛夏令营期间。当时我们有机会面对面和几位行业内的专家评委交流。
专家们对我们的‘课程大纲自动生成’功能很感兴趣，但在实测后，一位专家犀利地指出了一个问题：<strong>‘你们生成的每一个字我都认识，但感觉跟上传的这个课件关系不大，像是在一本正经地胡说八道。’</strong> 这就是典型的 <strong>RAG 幻觉</strong>问题。生成的每一章都看似专业，但其实是大模型用自己的训练数据编的，丢失了用户上传文档的<strong>特异性</strong>。”</p>
<p><strong>2. 归因分析 (Analysis)</strong> “我当时非常焦虑，回去立刻排查。
当时受限于学生服务器的算力（可能只有几核CPU，没有显卡），我们没法部署重型的 Re-rank（重排序）模型，也没法搭建 Elasticsearch 做混合检索（当时还没想到利用 Redis 的全文检索或是云端知识库）。
我们只用了最基础的<strong>向量检索（Vector Search）</strong>。
问题就出在<strong>切片</strong>上。把一份逻辑严密的教材切成碎片后，向量检索只能搜到‘关键词相似’的片段，丢失了整本书的<strong>目录结构</strong>和<strong>章节逻辑</strong>。大模型拿不到宏观结构，只能瞎编。”</p>
<p><strong>3. 解决方案 (Action) —— 专家的建议与落地</strong> “当时专家给了一个非常巧妙的思路，我们称之为<strong>LLM 导读模式</strong>（或者叫 Map-Reduce 思想），完全避开了复杂的检索算法：</p>
<ul>
<li>
<p><strong>第一步：全库浏览，提取目录（Map）。</strong> 对于几十页的文档，我们不再切片，而是让长窗口模型（Long-Context LLM）先快速通读全文，让它只做一件事：<strong>生成一份带页码的详细目录</strong>。</p>
</li>
<li>
<p><strong>第二步：让模型自主决策（Agentic Decision）。</strong> 当需要生成大纲时，我们把这份‘目录’扔给大模型，问它：‘你要写大纲，需要参考哪几部分内容？’
大模型会根据目录判断：‘我需要第 1-5 页的简介，和第 20-25 页的核心算法。’</p>
</li>
<li>
<p><strong>第三步：精准投喂（Fetch &amp; Generate）。</strong> 程序根据大模型返回的页码，直接去原始 PDF 里把这几页的<strong>完整文本</strong>提取出来，原封不动地喂给模型。
这样，模型看到的是完整的上下文，而不是破碎的片段。”</p>
</li>
</ul>
<p><strong>4. 结果 (Result)</strong> “改用这个方案后，虽然我们没有增加任何硬件成本，但生成效果有了质的飞跃。大纲的每一级标题都能精确对应到文档的具体章节，<strong>幻觉率几乎降到了零</strong>。这次经历也让我明白，解决 RAG 问题不一定非要靠堆算力，**数据处理的逻辑（Workflow）**往往比模型本身更重要。”</p>
<h3 id="题目生成">题目生成
</h3><p><strong>背景与挑战（起头：先说遇到的尴尬）</strong> “我想讲讲我在做那个 AI 出题项目时遇到的一个的挑战。
当时项目差不多写完了，离比赛交稿还有一周左右，我们找了自己的高中老师来试用我们的项目。结果老师们的反馈让我们挺意外的。
他们说：‘你们的 AI 很严谨，生成的题目完全没有科学性错误，也没有歧义，<strong>但是太水了</strong>。’
简单说就是，题目太简单，干扰项（错误选项）设计得太假，学生根本不用动脑子，一看就知道哪个是错的，用排除法直接就选对了。这对考察学生能力根本没用。我们当时问他们有没有切换一下难度选项，当时我们设置了3个难度等级，简单，中等，困难，他们切换了一下，结果发现结果没啥变化，还是比较简单”</p>
<p><strong>2. 归因分析（过渡：我是怎么排查的）</strong> “我当时就去扒我们的 Prompt 和工作流，发现主要有两个坑：
第一，<strong>干扰项太随意</strong>。AI 纯粹是为了凑四个选项，正确答案可能是知识库文档的内容，错误选项就是随便更改了知识库文档的一两个词语，根本没有设计什么‘思维陷阱’，甚至AI会出一些显而易见的错误来。
第二，<strong>我们给的例子（Example）不好</strong>。给大模型的参考案例太简单了，三个难度用的是同一套案例，导致AI认为案例就是对应的难度了，AI 就照葫芦画瓢，出的题也简单。</p>
<p><strong>3. 解决方案（高光：我是怎么修的——重点记这三招）</strong> “为了解决这个，我主要做了三件事：</p>
<ul>
<li>
<p><strong>第一，改干扰项的逻辑。</strong> 我改了 Prompt，中等和困难题目强制要求 AI <strong>‘站在学生的易错点上去出题’</strong>。比如故意模拟一些计算错误或者逻辑漏洞作为选项。这样学生想做对，就必须真的懂，光靠蒙是不行的。</p>
</li>
<li>
<p><strong>第二，把‘样题’升级了。</strong> 我把提示词里的参考案例全换成了那种需要深度思考的应用题，告诉大模型：‘这种有难度的题，才是我想要的’。</p>
</li>
<li>
<p><strong>第三，这也是最关键的一步，我加了个AI 质检员</strong> 先让普通模型出题，然后引入一个更厉害的模型Gemini2.5Pro当‘审核员’，以前的质检节点只是检查题目有没有问题，如果没有问题就去生成下一道或者结束任务了，现在AI会把生成题目的问题放入上下文中，然后让AI根据问题进行重新生成。直到审核通过，才会发给用户。并且还加了个兜底机制，既然普通模型（学生）教了 3 遍还不会，那就让高级模型（Gemini 2.5 Pro，老师）<strong>直接亲自上手改写</strong>，而不是只给意见了。”</p>
</li>
</ul>
<p><strong>4. 结果（收尾：最后效果咋样）</strong> “改完后，老师们的态度立马变了。他们说现在的题目<strong>有嚼头</strong>了，能真正考察学生会不会用知识，而不是死记硬背。后来这种<strong>生成-审核-修改</strong>的闭环模式，也成了我们项目的一个标准做法。”</p>
<h2 id="抢课系统">抢课系统
</h2><p><strong>面试官你好，关于这个抢课系统，我在设计时主要面临的挑战是：如何在巨大的流量冲击下，既保证库存不超卖，又要保证页面加载的高性能。</strong></p>
<p><strong>为了解决这个问题，我没有采用“一刀切”的缓存策略，而是根据数据的业务特性，把数据分成了两类，分别做了针对性的设计：</strong></p>
<h4 id="第一部分针对高频变化的抢课库存-解决写压力--强一致性">第一部分：针对“高频变化的抢课库存” (解决写压力 &amp; 强一致性)
</h4><p>“首先是核心的<strong>库存数据</strong>。因为抢课对一致性要求极高，绝对不能超卖，而且写并发很大。
所以对于这部分数据，我<strong>放弃了本地缓存</strong>，因为分布式环境下本地缓存很难保证实时强一致。</p>
<p>我采用了 <strong>Redis + Lua 脚本</strong> 的方案。
当抢课请求进来时，直接在 Redis 里通过 Lua 脚本原子性地扣减库存，这就保证了不会超卖。
然后，为了保护数据库不被瞬时流量打挂，我用 <strong>RocketMQ 做了一个异步削峰</strong>。抢课成功后，只发一个消息到 MQ，后端通过消费者批量拉取消息，比如每 10 秒或凑够 1000 条，再批量写入 MySQL。这样就把数据库的写压力降低了 90% 以上。”</p>
<h4 id="第二部分针对低频变化的课程详情-解决读压力--最终一致性">第二部分：针对“低频变化的课程详情” (解决读压力 &amp; 最终一致性)
</h4><p>“第二类是<strong>课程详情</strong>，比如课程名称、老师介绍。这类数据读多写少，对实时性要求没那么苛刻，秒级延迟是可以接受的。
所以为了极致的读性能，我设计了 <strong>Caffeine + Redis + MySQL 的三级缓存架构</strong>。
大部分请求直接打在 Caffeine 本地内存里就返回了，根本不用走网络 IO，性能非常高。”</p>
<p><strong>【这里要重点讲难点：分布式缓存一致性】</strong> “但引入本地缓存带来了一个<strong>最大的难点</strong>：就是<strong>多节点间的数据一致性</strong>。如果我在节点 A 修改了课程描述，节点 B 的本地缓存还是旧的，怎么办？
针对这个问题，我利用了 <strong>RocketMQ 的广播模式（Broadcasting）</strong>。
一旦后台修改了课程信息，除了更新库和 Redis，还会发一条‘失效消息’。所有应用节点订阅这个 Topic，收到消息后，<strong>只做一个动作：清除本地缓存</strong>。
这样下一次请求进来时，自然会去 Redis 拉取最新的数据，实现了集群下的缓存最终一致性。”</p>
<h4 id="第三部分细节优化-展示技术深度">第三部分：细节优化 (展示技术深度)
</h4><p>“在细节实现上，我还做了两个优化：</p>
<ol>
<li>
<p><strong>Caffeine 的过期策略</strong>：我选用了 <code>expireAfterAccess</code> 而不是 <code>expireAfterWrite</code>。因为热门课程会被频繁查看，只要有人看，它就应该留在内存里，这样能最大程度减少 Redis 的压力。</p>
</li>
<li>
<p><strong>防缓存击穿</strong>：在本地缓存失效回源查 Redis 时，我利用了 Caffeine 自带的 <code>get(key, loader)</code> 机制。它底层会自动合并请求，保证同一个 Key 在同一瞬间只有一个线程去查 Redis，避免了大量请求同时打穿到后端，这比自己写 DCL（双重检查锁）要优雅且高效得多。”</p>
</li>
</ol>
<hr>
<h3 id="-预判面试官的追问-prepare-for-defense">💡 预判面试官的追问 (Prepare for Defense)
</h3><p>讲完上面的话术后，面试官大概率会问以下问题，你可以提前准备：</p>
<p><strong>Q1: 为什么收到 MQ 广播后是“删除缓存”而不是“更新缓存”？</strong></p>
<ul>
<li><strong>回答：</strong> 这是一个经典的缓存模式（Cache-Aside Pattern）。如果直接更新，可能会出现并发写导致的脏数据问题（比如两个消息先后到达，但处理顺序反了）。而且如果该课程暂时没人看，主动更新缓存是浪费资源。<strong>“删除”也就是延迟加载（Lazy Load）</strong>，等下次有人查的时候再加载，既安全又节省资源。</li>
</ul>
<p><strong>Q2: 既然用了 Redis，为什么库存还要异步写入 MySQL？直接写不行吗？</strong></p>
<ul>
<li><strong>回答：</strong> 抢课瞬间流量可能是数据库 TPS 的几十倍。如果每扣一次 Redis 就去写一次 MySQL，数据库连接池瞬间就会爆掉。异步写入是为了<strong>保护数据库</strong>，将随机写转换为批量顺序写，这是高并发下保护持久层的标准做法。</li>
</ul>
<p><strong>Q3: 如果 RocketMQ 发送失败了，本地缓存不就不一致了吗？</strong></p>
<ul>
<li><strong>回答：</strong> 是的，所以我们在 Caffeine 上还加了一个兜底的<strong>过期时间</strong>（比如 5 分钟）。MQ 保证的是<strong>准实时</strong>的一致性（秒级），而过期时间保证了<strong>最终</strong>的一致性。就算 MQ 挂了，5 分钟后缓存自动过期，数据也会修正过来。</li>
</ul>
<p><strong>Q4: Caffeine 这种堆内缓存，会不会导致 OOM (内存溢出)？</strong></p>
<ul>
<li><strong>回答：</strong> 不会，因为我严格限制了 <code>maximumSize(5000)</code>。Caffeine 底层使用 <strong>Window TinyLfu</strong> 算法，会自动淘汰访问频率低的数据，确保存储的都是热点数据，且内存占用可控。</li>
</ul>
<h3 id="q-抢课数据为什么不走本地缓存">Q: 抢课数据为什么不走本地缓存？
</h3><blockquote>
<p>&ldquo;抢课涉及库存扣减，必须保证<strong>强一致性</strong>。如果用本地缓存：</p>
<ol>
<li>节点A扣减本地缓存，节点B不知道</li>
<li>可能导致超卖</li>
</ol>
<p>所以抢课直接操作 Redis，用 Lua 脚本保证原子性。本地缓存只用于<strong>课程详情</strong>这种低频变化的数据。&rdquo;</p>
</blockquote>
<h3 id="q-课程详情为什么用续期策略">Q: 课程详情为什么用续期策略？
</h3><blockquote>
<p>&ldquo;课程详情（名称、描述、教师）<strong>很少变化</strong>，用 <code>expireAfterAccess</code> 续期策略：</p>
<ul>
<li>热门课程被频繁查看，可以一直命中本地缓存</li>
<li>减少 Redis 访问，提升性能</li>
<li>续期只是更新一个时间戳，开销 &lt; 1 纳秒</li>
</ul>
<p>如果是库存这种频繁变化的数据，就不能用续期，否则数据会严重过时。&rdquo;</p>
</blockquote>
<h3 id="q-多节点本地缓存怎么同步">Q: 多节点本地缓存怎么同步？
</h3><blockquote>
<p>&ldquo;用 RocketMQ 广播模式：</p>
<ol>
<li>数据变更时，发送缓存失效消息</li>
<li>所有节点都订阅这个 Topic（广播模式）</li>
<li>收到消息后，清除对应的本地缓存</li>
<li>下次请求时，从 Redis 重新加载</li>
</ol>
<p>会有几十到几百毫秒的不一致窗口，但对于课程详情这种数据完全可接受。&rdquo;</p>
</blockquote>
<h3 id="q-缓存失效后大量请求同时查-redis-怎么办">Q: 缓存失效后大量请求同时查 Redis 怎么办？
</h3><blockquote>
<p>&ldquo;这是<strong>缓存击穿</strong>问题。我用 Caffeine 的 <code>get(key, loader)</code> 方法：</p>
<ul>
<li>它内部用 <code>CompletableFuture</code> 实现</li>
<li>第一个线程执行 loader 查 Redis</li>
<li>其他线程等待同一个 Future 的结果</li>
<li>无需手动加锁，只有 1 次 Redis 查询</li>
</ul>
<p>也可以用 DCL（Double-Check Locking）或 CAS 自旋实现类似效果。&rdquo;</p>
</blockquote>
<h3 id="q-rocketmq-在你的系统中做了什么">Q: RocketMQ 在你的系统中做了什么？
</h3><blockquote>
<p>&ldquo;RocketMQ 在我的系统中有两个作用：</p>
<p><strong>1. 抢课数据异步落库</strong>：</p>
<ul>
<li>抢课成功后发送消息</li>
<li>Consumer 批量消费（1000条/10秒）</li>
<li>批量写入 MySQL，数据库操作减少 90%+</li>
</ul>
<p><strong>2. 分布式缓存同步</strong>：</p>
<ul>
<li>课程信息修改后发送广播消息</li>
<li>所有节点清除本地缓存</li>
<li>保证多节点缓存一致性&rdquo;</li>
</ul>
</blockquote>
<h2 id="eduagentx-项目面试问答文档">EduAgentX 项目面试问答文档
</h2><blockquote>
<p>本文档针对EduAgentX智能教育平台项目，整理了面试中可能被深入追问的技术细节，帮助你应对二面技术拷问。</p>
</blockquote>
<h2 id="目录">目录
</h2><ul>
<li><a class="link" href="#%E4%B8%80redis%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82" >一、Redis技术细节</a></li>
<li><a class="link" href="#%E4%BA%8C%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84" >二、微服务架构</a></li>
<li><a class="link" href="#%E4%B8%89%E9%AB%98%E5%B9%B6%E5%8F%91%E6%8A%A2%E8%AF%BE%E7%B3%BB%E7%BB%9F" >三、高并发抢课系统</a></li>
<li><a class="link" href="#%E5%9B%9Bai%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%B3%BB%E7%BB%9F" >四、AI工作流系统</a></li>
<li><a class="link" href="#%E4%BA%94%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8Eorm" >五、数据库与ORM</a></li>
<li><a class="link" href="#%E5%85%AD%E5%AE%89%E5%85%A8%E4%B8%8E%E8%AE%A4%E8%AF%81" >六、安全与认证</a></li>
<li><a class="link" href="#%E4%B8%83rocketmq%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" >七、RocketMQ消息队列</a></li>
<li><a class="link" href="#%E5%85%AB%E9%98%BF%E9%87%8C%E4%BA%91oss%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8" >八、阿里云OSS文件存储</a></li>
<li><a class="link" href="#%E4%B9%9D%E4%B8%8A%E7%BA%BF%E8%BF%90%E7%BB%B4" >九、上线运维</a></li>
<li><a class="link" href="#%E5%8D%81%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%8E%E5%85%A8%E5%B1%80%E5%93%8D%E5%BA%94" >十、异常处理与全局响应</a></li>
<li><a class="link" href="#%E5%8D%81%E4%B8%80%E6%8A%80%E6%9C%AF%E6%A0%88%E9%80%89%E5%9E%8B" >十一、技术栈选型</a></li>
</ul>
<hr>
<h2 id="一redis技术细节">一、Redis技术细节
</h2><h3 id="11-redis序列化方式">1.1 Redis序列化方式
</h3><p><strong>Q: 你的项目中Redis使用了什么序列化方式？为什么这样选择？</strong></p>
<p><strong>A:</strong> 项目中配置了两个RedisTemplate，使用不同的序列化策略：</p>
<ol>
<li><strong>通用RedisTemplate</strong> - 使用<code>Jackson2JsonRedisSerializer</code>序列化Value</li>
<li><strong>Lua脚本专用RedisTemplate</strong> - 使用<code>StringRedisSerializer</code>全字符串序列化</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RedisConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">redisTemplate</span><span class="p">(</span><span class="n">RedisConnectionFactory</span><span class="w"> </span><span class="n">connectionFactory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">template</span><span class="p">.</span><span class="na">setConnectionFactory</span><span class="p">(</span><span class="n">connectionFactory</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 使用 Jackson2JsonRedisSerializer 序列化值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">objectMapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">objectMapper</span><span class="p">.</span><span class="na">activateDefaultTyping</span><span class="p">(</span><span class="n">LaissezFaireSubTypeValidator</span><span class="p">.</span><span class="na">instance</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ObjectMapper</span><span class="p">.</span><span class="na">DefaultTyping</span><span class="p">.</span><span class="na">NON_FINAL</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Jackson2JsonRedisSerializer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">serializer</span><span class="w"> </span><span class="o">=</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">Jackson2JsonRedisSerializer</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">objectMapper</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Key 使用 String 序列化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">template</span><span class="p">.</span><span class="na">setKeySerializer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StringRedisSerializer</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">template</span><span class="p">.</span><span class="na">setValueSerializer</span><span class="p">(</span><span class="n">serializer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">template</span><span class="p">.</span><span class="na">setHashKeySerializer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StringRedisSerializer</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">template</span><span class="p">.</span><span class="na">setHashValueSerializer</span><span class="p">(</span><span class="n">serializer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">template</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">luaRedisTemplate</span><span class="p">(</span><span class="n">RedisConnectionFactory</span><span class="w"> </span><span class="n">connectionFactory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">template</span><span class="p">.</span><span class="na">setConnectionFactory</span><span class="p">(</span><span class="n">connectionFactory</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 全部使用 String 序列化，用于Lua脚本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">StringRedisSerializer</span><span class="w"> </span><span class="n">stringSerializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StringRedisSerializer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">template</span><span class="p">.</span><span class="na">setKeySerializer</span><span class="p">(</span><span class="n">stringSerializer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">template</span><span class="p">.</span><span class="na">setValueSerializer</span><span class="p">(</span><span class="n">stringSerializer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">template</span><span class="p">.</span><span class="na">setHashKeySerializer</span><span class="p">(</span><span class="n">stringSerializer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">template</span><span class="p">.</span><span class="na">setHashValueSerializer</span><span class="p">(</span><span class="n">stringSerializer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">template</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>选择原因：</strong></p>
<ul>
<li><strong>Jackson2JsonRedisSerializer</strong>: 支持复杂对象序列化，可读性好，便于调试</li>
<li><strong>StringRedisSerializer</strong>: Lua脚本中需要纯字符串操作，避免JSON前缀导致的类型转换问题</li>
<li><strong>Key统一用String</strong>: 避免Key带有序列化前缀，便于在Redis客户端直接查看</li>
</ul>
<p><strong>深入追问：</strong></p>
<p><strong>Q: 为什么不用JDK序列化？</strong> A: JDK序列化存在以下问题：</p>
<ul>
<li>序列化后的数据包含类信息，体积大</li>
<li>可读性差，无法在Redis客户端直接查看</li>
<li>存在安全漏洞（反序列化攻击）</li>
<li>跨语言兼容性差</li>
</ul>
<p><strong>Q: activateDefaultTyping的作用是什么？</strong> A: 启用类型信息记录，序列化时会在JSON中包含<code>@class</code>字段，反序列化时能正确还原对象类型。这对于存储多态对象很重要。</p>
<hr>
<h3 id="12-lua脚本原子操作">1.2 Lua脚本原子操作
</h3><p><strong>Q: 抢课系统中的Lua脚本是怎么设计的？如何保证原子性？</strong></p>
<p><strong>A:</strong> 抢课使用Lua脚本实现原子性操作，一次网络往返完成：检查→扣减→记录。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RedisScript</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SNATCH_SCRIPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultRedisScript</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    local tempSnatchKey = KEYS[1]
</span></span></span><span class="line"><span class="cl"><span class="s">    local studentSnatchKey = KEYS[2]
</span></span></span><span class="line"><span class="cl"><span class="s">    local subjectCapacityKey = KEYS[3]
</span></span></span><span class="line"><span class="cl"><span class="s">    local studentId = ARGV[1]
</span></span></span><span class="line"><span class="cl"><span class="s">    local subjectId = ARGV[2]
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    -- 1. 检查是否已抢课
</span></span></span><span class="line"><span class="cl"><span class="s">    local hasSnatch = redis.call(&#39;HEXISTS&#39;, studentSnatchKey, subjectId)
</span></span></span><span class="line"><span class="cl"><span class="s">    if hasSnatch == 1 then
</span></span></span><span class="line"><span class="cl"><span class="s">        return -1  -- 已抢课
</span></span></span><span class="line"><span class="cl"><span class="s">    end
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    -- 2. 原子性扣减库存
</span></span></span><span class="line"><span class="cl"><span class="s">    local newCapacity = redis.call(&#39;HINCRBY&#39;, subjectCapacityKey, subjectId, -1)
</span></span></span><span class="line"><span class="cl"><span class="s">    if newCapacity &lt; 0 then
</span></span></span><span class="line"><span class="cl"><span class="s">        redis.call(&#39;HINCRBY&#39;, subjectCapacityKey, subjectId, 1)  -- 回滚
</span></span></span><span class="line"><span class="cl"><span class="s">        return -2  -- 库存不足
</span></span></span><span class="line"><span class="cl"><span class="s">    end
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    -- 3. 批量写入
</span></span></span><span class="line"><span class="cl"><span class="s">    local hashKey = studentId .. &#39;:&#39; .. subjectId
</span></span></span><span class="line"><span class="cl"><span class="s">    redis.call(&#39;HINCRBY&#39;, tempSnatchKey, hashKey, 1)
</span></span></span><span class="line"><span class="cl"><span class="s">    redis.call(&#39;HSET&#39;, studentSnatchKey, subjectId, 1)
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    return 1  -- 成功
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>原子性保证机制：</strong></p>
<ol>
<li><strong>Redis单线程执行</strong>: Lua脚本在Redis中原子执行，不会被其他命令打断</li>
<li><strong>HINCRBY原子操作</strong>: 扣减库存使用原子递减，避免超卖</li>
<li><strong>失败回滚</strong>: 库存不足时立即回滚，保证数据一致性</li>
</ol>
<p><strong>返回值设计：</strong></p>
<ul>
<li><code>-1</code>: 已抢课，不能重复抢</li>
<li><code>-2</code>: 课程容量不足</li>
<li><code>1</code>: 抢课成功</li>
</ul>
<p><strong>深入追问：</strong></p>
<p><strong>Q: 为什么用HINCRBY而不是先HGET再HSET？</strong> A: 在Lua脚本内部，两者的原子性是等价的（因为整个Lua脚本本身就是原子执行的）。选择HINCRBY的原因是：</p>
<ul>
<li><strong>代码简洁</strong>：一条命令完成读取+计算+写入</li>
<li><strong>避免类型转换</strong>：HGET返回字符串，需要tonumber()转换后再计算，HINCRBY直接操作数值</li>
<li><strong>直接返回新值</strong>：HINCRBY返回操作后的新值，方便判断库存是否为负</li>
</ul>
<p><strong>Q: 那HINCRBY的原子性优势体现在哪里？</strong> A: 如果不用Lua脚本，而是在Java代码中分别调用HGET和HSET，那就会有并发问题。HINCRBY的原子性优势体现在<strong>单独使用时</strong>，而不是在Lua脚本内部。</p>
<p><strong>Q: Lua脚本有什么限制？</strong> A:</p>
<ul>
<li>不能使用随机函数（影响主从复制）</li>
<li>执行时间不宜过长（阻塞其他请求）</li>
<li>所有Key必须在同一个Redis节点（集群模式需要用Hash Tag）</li>
</ul>
<hr>
<h3 id="13-多级缓存架构">1.3 多级缓存架构
</h3><p><strong>Q: 项目中的多级缓存是怎么设计的？</strong></p>
<p><strong>A:</strong> 采用 <strong>Caffeine本地缓存 + Redis分布式缓存</strong> 的两级架构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CacheManager</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Cache</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">localCache</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Caffeine</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">maximumSize</span><span class="p">(</span><span class="n">10000</span><span class="p">)</span><span class="w">                      </span><span class="c1">// 最大缓存10000条</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">expireAfterWrite</span><span class="p">(</span><span class="n">60</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">)</span><span class="w">  </span><span class="c1">// 60秒过期</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">recordStats</span><span class="p">()</span><span class="w">                           </span><span class="c1">// 启用统计</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>缓存查询流程：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">请求 → 本地缓存(Caffeine) → Redis → 数据库
</span></span><span class="line"><span class="cl">       ↑ 命中返回          ↑ 命中返回  ↑ 查询并缓存
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>实际使用代码：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="nf">getSubjectCapacityWithCache</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">subjectId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">cacheKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;capacity:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">subjectId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 先查本地缓存</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">cached</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">localCache</span><span class="p">.</span><span class="na">getIfPresent</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cached</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span><span class="w"> </span><span class="n">cached</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 查询Redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">capacityObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">luaRedisTemplate</span><span class="p">.</span><span class="na">opsForHash</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">capacityKey</span><span class="p">,</span><span class="w"> </span><span class="n">subjectId</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 热Key检测，决定是否缓存到本地</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">AddResult</span><span class="w"> </span><span class="n">addResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hotKeyDetector</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">buildCacheKey</span><span class="p">(</span><span class="n">subjectId</span><span class="p">),</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addResult</span><span class="p">.</span><span class="na">isHotKey</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">localCache</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span><span class="w"> </span><span class="n">capacityValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">capacityValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>深入追问：</strong></p>
<p><strong>Q: 本地缓存和Redis缓存的数据一致性怎么保证？</strong> A:</p>
<ul>
<li>本地缓存设置较短过期时间（60秒）</li>
<li>写操作时主动失效本地缓存</li>
<li>对于强一致性场景，直接查Redis</li>
</ul>
<p><strong>Q: 为什么选择Caffeine而不是Guava Cache？</strong> A: Caffeine是Guava Cache的升级版，性能更好：</p>
<ul>
<li>使用Window TinyLFU淘汰算法，命中率更高</li>
<li>异步加载支持更好</li>
<li>统计功能更完善</li>
</ul>
<hr>
<h3 id="14-heavykeeper热key检测">1.4 HeavyKeeper热Key检测
</h3><p><strong>Q: 热Key检测是怎么实现的？</strong></p>
<p><strong>A:</strong> 使用HeavyKeeper算法实现热Key检测，这是一种概率数据结构，能在有限内存下高效识别高频访问的Key。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HeavyKeeper</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">TopK</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w">           </span><span class="c1">// Top K</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">;</span><span class="w">       </span><span class="c1">// 桶宽度</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">depth</span><span class="p">;</span><span class="w">       </span><span class="c1">// 桶深度</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="o">[]</span><span class="w"> </span><span class="n">lookupTable</span><span class="p">;</span><span class="w">  </span><span class="c1">// 衰减查找表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Bucket</span><span class="o">[][]</span><span class="w"> </span><span class="n">buckets</span><span class="p">;</span><span class="w">    </span><span class="c1">// 计数桶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PriorityQueue</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">minHeap</span><span class="p">;</span><span class="w">  </span><span class="c1">// 最小堆维护TopK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">HeavyKeeper</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">depth</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">decay</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">minCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w">              </span><span class="c1">// 监控Top 100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">;</span><span class="w">      </span><span class="c1">// 100000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">depth</span><span class="p">;</span><span class="w">      </span><span class="c1">// 5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">minCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minCount</span><span class="p">;</span><span class="w"> </span><span class="c1">// 最小出现3次</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 预计算衰减表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">256</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">lookupTable</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">pow</span><span class="p">(</span><span class="n">decay</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">AddResult</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">increment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 1. 计算指纹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">itemFingerprint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">maxCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 2. 更新多层桶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">depth</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">bucketNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">getBytes</span><span class="p">()))</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">width</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Bucket</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buckets</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">bucketNumber</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bucket</span><span class="p">.</span><span class="na">fingerprint</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">itemFingerprint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">bucket</span><span class="p">.</span><span class="na">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">increment</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">maxCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="n">maxCount</span><span class="p">,</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">count</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// 概率衰减</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">decay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookupTable</span><span class="o">[</span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">bucket</span><span class="p">.</span><span class="na">count</span><span class="p">,</span><span class="w"> </span><span class="n">255</span><span class="p">)</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">decay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">bucket</span><span class="p">.</span><span class="na">count</span><span class="o">--</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bucket</span><span class="p">.</span><span class="na">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">bucket</span><span class="p">.</span><span class="na">fingerprint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">itemFingerprint</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">bucket</span><span class="p">.</span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">increment</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 3. 更新TopK堆</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AddResult</span><span class="p">(</span><span class="n">expelled</span><span class="p">,</span><span class="w"> </span><span class="n">isHot</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>配置参数：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">hotKeyDetector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HeavyKeeper</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">100</span><span class="p">,</span><span class="w">      </span><span class="c1">// 监控Top 100 Key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">100000</span><span class="p">,</span><span class="w">   </span><span class="c1">// 宽度</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">5</span><span class="p">,</span><span class="w">        </span><span class="c1">// 深度</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">0</span><span class="p">.</span><span class="na">92</span><span class="p">,</span><span class="w">     </span><span class="c1">// 衰减系数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">3</span><span class="w">         </span><span class="c1">// 最小出现3次才记录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>深入追问：</strong></p>
<p><strong>Q: HeavyKeeper相比Count-Min Sketch有什么优势？</strong> A:</p>
<ul>
<li>Count-Min Sketch只能估计频率，不能直接获取TopK</li>
<li>HeavyKeeper结合了Count-Min Sketch和Space-Saving算法</li>
<li>内存效率更高，误差更小</li>
</ul>
<p><strong>Q: 为什么需要定时fading？</strong> A: 防止历史热Key长期占据TopK位置，通过定期衰减让新的热Key有机会进入。</p>
<hr>
<h2 id="二微服务架构">二、微服务架构
</h2><h3 id="21-dubbo配置与调用">2.1 Dubbo配置与调用
</h3><p><strong>Q: 项目中Dubbo是怎么配置的？用的什么协议？</strong></p>
<p><strong>A:</strong> 使用Apache Dubbo 3.x，配置Triple协议 + Nacos注册中心：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># application.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">dubbo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">registry</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">nacos://127.0.0.1:8848?username=nacos&amp;password=nacos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">register-mode</span><span class="p">:</span><span class="w"> </span><span class="l">instance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">protocol</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tri         </span><span class="w"> </span><span class="c"># Triple协议（基于gRPC）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">50052</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">consumer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">60000</span><span class="w">     </span><span class="c"># 60秒超时</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">check</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">       </span><span class="c"># 启动时不检查服务提供者</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">         </span><span class="c"># 失败重试2次</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">60000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">qos-port</span><span class="p">:</span><span class="w"> </span><span class="m">22222</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata-type</span><span class="p">:</span><span class="w"> </span><span class="l">remote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metadata-report</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">nacos://127.0.0.1:8848?username=nacos&amp;password=nacos</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Triple协议选择原因：</strong></p>
<ul>
<li>基于HTTP/2，支持流式传输</li>
<li>兼容gRPC，跨语言调用更方便</li>
<li>性能优于传统Dubbo协议</li>
<li>支持应用级服务发现</li>
</ul>
<p><strong>深入追问：</strong></p>
<p><strong>Q: check: false是什么意思？</strong> A: 启动时不检查服务提供者是否存在。在微服务场景下，服务可能还没启动完成，设置false避免启动失败。</p>
<p><strong>Q: retries: 2会不会导致重复请求？</strong> A: 会的，所以对于非幂等接口（如抢课），需要在业务层做幂等处理，比如先检查是否已抢课，或者查询信息（幂等性的信息适合使用重复请求）。</p>
<p><strong>在代码中通过注解对“查询接口”单独开启</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 只有查询接口，才手动指定重试次数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboReference</span><span class="p">(</span><span class="n">retries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">2</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">3000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">UserQueryService</span><span class="w"> </span><span class="n">userQueryService</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="22-服务拆分策略">2.2 服务拆分策略
</h3><p><strong>Q: 项目拆分成了哪些微服务？拆分原则是什么？</strong></p>
<p><strong>A:</strong> 项目按业务领域拆分为以下微服务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">EduAgentX-MicroService/
</span></span><span class="line"><span class="cl">├── EduAgentX-User        # 用户服务 (端口8124)
</span></span><span class="line"><span class="cl">├── EduAgentX-Course      # 课程服务 (端口8125)
</span></span><span class="line"><span class="cl">├── EduAgentX-Question    # 题目服务 (端口8126)
</span></span><span class="line"><span class="cl">├── EduAgentX-Snatch      # 抢课服务 (端口8127)
</span></span><span class="line"><span class="cl">├── EduAgentX-File        # 文件服务 (端口8128)
</span></span><span class="line"><span class="cl">├── EduAgentX-RagService  # RAG服务 (端口8129)
</span></span><span class="line"><span class="cl">├── EduAgentX-AI-Workflow # AI工作流服务 (端口8130)
</span></span><span class="line"><span class="cl">├── EduAgentX-Client      # 内部调用接口定义
</span></span><span class="line"><span class="cl">├── EduAgentX-Common      # 公共模块
</span></span><span class="line"><span class="cl">└── EduAgentX-Model       # 数据模型
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>拆分原则：</strong></p>
<ol>
<li><strong>单一职责</strong>: 每个服务只负责一个业务领域</li>
<li><strong>高内聚低耦合</strong>: 服务内部高度内聚，服务间通过接口通信</li>
<li><strong>独立部署</strong>: 每个服务可以独立部署、扩容</li>
<li><strong>数据隔离</strong>: 每个服务有自己的数据库表（逻辑隔离）</li>
</ol>
<p><strong>深入追问：</strong></p>
<p><strong>Q: 为什么抢课服务要单独拆出来？</strong> A: 抢课是高并发场景，需要独立扩容。拆分后可以：</p>
<ul>
<li>单独优化Redis连接池</li>
<li>独立限流配置</li>
<li>不影响其他服务稳定性</li>
</ul>
<hr>
<h3 id="23-跨服务调用设计">2.3 跨服务调用设计
</h3><p><strong>Q: 微服务之间是怎么调用的？</strong></p>
<p><strong>A:</strong> 通过定义InnerService接口 + @DubboService实现：</p>
<p><strong>接口定义（EduAgentX-Client模块）：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">InnerUserService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">listByIds</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Serializable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ids</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="nf">getById</span><span class="p">(</span><span class="n">Serializable</span><span class="w"> </span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">UserVO</span><span class="w"> </span><span class="nf">getUserVO</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 静态方法，避免跨服务调用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">getLoginUser</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">userObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">().</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">USER_LOGIN_STATE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">currentUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="w"> </span><span class="n">userObj</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">currentUser</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">currentUser</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ErrorCode</span><span class="p">.</span><span class="na">NOT_LOGIN_ERROR</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">currentUser</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>服务实现（EduAgentX-Snatch模块）：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@DubboService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InnerSnatchSubjectServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">InnerSnatchSubjectService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SnatchSubjectService</span><span class="w"> </span><span class="n">snatchSubjectService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initSubjectCapacityToRedis</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">subjectId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">snatchSubjectService</span><span class="p">.</span><span class="na">initSubjectCapacityToRedis</span><span class="p">(</span><span class="n">subjectId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SnatchSubject</span><span class="w"> </span><span class="nf">getBySubjectId</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">subjectId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">snatchSubjectService</span><span class="p">.</span><span class="na">getBySubjectId</span><span class="p">(</span><span class="n">subjectId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>调用方使用：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@DubboReference</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">InnerUserService</span><span class="w"> </span><span class="n">innerUserService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">someMethod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">innerUserService</span><span class="p">.</span><span class="na">getById</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>深入追问：</strong></p>
<p><strong>Q: 为什么getLoginUser用静态方法？</strong> A: 获取登录用户需要HttpServletRequest，这个对象无法跨服务传递。使用静态方法在本地从Session获取，避免RPC调用。</p>
<hr>
<h3 id="24-分布式session">2.4 分布式Session
</h3><p><strong>Q: 微服务之间Session是怎么共享的？</strong></p>
<p><strong>A:</strong> 使用Spring Session + Redis实现分布式Session：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">session</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">store-type</span><span class="p">:</span><span class="w"> </span><span class="l">redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">2880m          </span><span class="w"> </span><span class="c"># 48小时</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">spring:session</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>工作原理：</strong></p>
<ol>
<li>用户登录后，Session存储到Redis</li>
<li>所有微服务连接同一个Redis</li>
<li>请求携带JSESSIONID，从Redis获取Session</li>
</ol>
<p><strong>Session存储结构：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">spring:session:sessions:{sessionId}
</span></span><span class="line"><span class="cl">├── creationTime
</span></span><span class="line"><span class="cl">├── lastAccessedTime
</span></span><span class="line"><span class="cl">├── maxInactiveInterval
</span></span><span class="line"><span class="cl">└── sessionAttr:USER_LOGIN_STATE  # 用户登录信息
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>深入追问：</strong></p>
<p><strong>Q: Session过期时间为什么设置48小时？</strong> A: 教育场景下用户可能长时间使用，设置较长过期时间提升体验。同时Redis会自动清理过期Session。</p>
<p><strong>Q: 如果Redis挂了怎么办？</strong> A:</p>
<ul>
<li>短期：用户需要重新登录</li>
<li>长期：可以考虑Redis集群或哨兵模式保证高可用</li>
</ul>
<hr>
<h3 id="25-dubbo底层原理深入">2.5 Dubbo底层原理深入
</h3><p><strong>Q: Dubbo的服务调用过程是怎样的？从发起调用到收到响应经历了哪些步骤？</strong></p>
<p><strong>A:</strong> 完整的调用链路如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Consumer端:
</span></span><span class="line"><span class="cl">1. Proxy代理 → 2. Filter链 → 3. Invoker → 4. Directory → 5. Router → 6. LoadBalance → 7. Invoker → 8. Protocol → 9. Exchanger → 10. Transporter(Netty)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Provider端:
</span></span><span class="line"><span class="cl">1. Transporter(Netty) → 2. Exchanger → 3. Protocol → 4. Filter链 → 5. Invoker → 6. 实际服务实现
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>详细流程：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 1. 代理层：生成代理对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">UserService</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">getProxy</span><span class="p">(</span><span class="n">UserService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 2. 调用时，代理对象调用InvokerInvocationHandler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">proxy</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 构建RpcInvocation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">RpcInvocation</span><span class="w"> </span><span class="n">invocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RpcInvocation</span><span class="p">(</span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 4. 通过Directory获取所有可用Invoker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Invoker</span><span class="o">&gt;</span><span class="w"> </span><span class="n">invokers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">directory</span><span class="p">.</span><span class="na">list</span><span class="p">(</span><span class="n">invocation</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 5. Router过滤（标签路由、条件路由等）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">invokers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">router</span><span class="p">.</span><span class="na">route</span><span class="p">(</span><span class="n">invokers</span><span class="p">,</span><span class="w"> </span><span class="n">invocation</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 6. LoadBalance选择一个Invoker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Invoker</span><span class="w"> </span><span class="n">invoker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadBalance</span><span class="p">.</span><span class="na">select</span><span class="p">(</span><span class="n">invokers</span><span class="p">,</span><span class="w"> </span><span class="n">invocation</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 7. 发起远程调用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Result</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invoker</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">invocation</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getValue</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Q: Dubbo的Invoker是什么？为什么说它是核心模型？</strong></p>
<p><strong>A:</strong> Invoker是Dubbo的核心抽象，代表一个可执行体：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getInterface</span><span class="p">();</span><span class="w">      </span><span class="c1">// 服务接口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">URL</span><span class="w"> </span><span class="nf">getUrl</span><span class="p">();</span><span class="w">                  </span><span class="c1">// 服务地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Result</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Invocation</span><span class="w"> </span><span class="n">invocation</span><span class="p">);</span><span class="w">  </span><span class="c1">// 执行调用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Invoker的类型：</strong></p>
<ul>
<li><strong>本地Invoker</strong>：直接调用本地实现</li>
<li><strong>远程Invoker</strong>：封装了网络通信逻辑</li>
<li><strong>集群Invoker</strong>：封装了负载均衡、容错逻辑</li>
</ul>
<p><strong>为什么是核心：</strong></p>
<ul>
<li>统一了本地调用和远程调用的抽象</li>
<li>所有的Filter、Router、LoadBalance都围绕Invoker工作</li>
<li>服务暴露和引用的最终产物都是Invoker</li>
</ul>
<p><strong>Q: Dubbo的Filter机制是怎样的？如何自定义Filter？</strong></p>
<p><strong>A:</strong> Filter是Dubbo的拦截器机制，类似于Servlet Filter：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 自定义Filter示例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Activate</span><span class="p">(</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">CommonConstants</span><span class="p">.</span><span class="na">CONSUMER</span><span class="p">,</span><span class="w"> </span><span class="n">CommonConstants</span><span class="p">.</span><span class="na">PROVIDER</span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LogFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Filter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Invoker</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">invoker</span><span class="p">,</span><span class="w"> </span><span class="n">Invocation</span><span class="w"> </span><span class="n">invocation</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RpcException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">methodName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invocation</span><span class="p">.</span><span class="na">getMethodName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 前置处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;调用方法: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">methodName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 执行调用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Result</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invoker</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">invocation</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 后置处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startTime</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;方法 {} 耗时: {}ms&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">methodName</span><span class="p">,</span><span class="w"> </span><span class="n">cost</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;调用异常: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>配置文件（META-INF/dubbo/org.apache.dubbo.rpc.Filter）：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">logFilter=com.lucius.eduAgentX.filter.LogFilter
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>内置Filter：</strong></p>
<ul>
<li><strong>ConsumerContextFilter</strong>：设置调用上下文</li>
<li><strong>FutureFilter</strong>：处理异步调用</li>
<li><strong>MonitorFilter</strong>：监控统计</li>
<li><strong>TimeoutFilter</strong>：超时处理</li>
<li><strong>ExceptionFilter</strong>：异常处理</li>
</ul>
<p><strong>Q: Dubbo的Directory和Router有什么区别？</strong></p>
<p><strong>A:</strong></p>
<p><strong>Directory（服务目录）：</strong></p>
<ul>
<li>存储所有可用的服务提供者列表</li>
<li>监听注册中心变化，动态更新列表</li>
<li>类似于&quot;电话簿&quot;</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Directory</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">Invocation</span><span class="w"> </span><span class="n">invocation</span><span class="p">);</span><span class="w">  </span><span class="c1">// 获取所有Invoker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Router（路由器）：</strong></p>
<ul>
<li>对Directory返回的列表进行过滤</li>
<li>实现条件路由、标签路由等</li>
<li>类似于&quot;筛选器&quot;</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Router</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Invoker</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">route</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Invoker</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">invokers</span><span class="p">,</span><span class="w"> </span><span class="n">Invocation</span><span class="w"> </span><span class="n">invocation</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>路由规则示例：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 条件路由：北京机房的消费者只调用北京机房的提供者</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;host = 192.168.1.* =&gt; host = 192.168.1.*&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># 标签路由：灰度发布</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">tags</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gray</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">addresses</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">192.168.1.100</span><span class="p">,</span><span class="w"> </span><span class="m">192.168.1.101</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Q: Dubbo的服务暴露过程是怎样的？</strong></p>
<p><strong>A:</strong> 服务暴露的核心流程：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="err">@</span><span class="n">DubboService注解</span> <span class="err">→</span> <span class="n">ServiceBean</span> <span class="err">→</span> <span class="n">ServiceConfig</span><span class="o">.</span><span class="k">export</span><span class="p">()</span> <span class="err">→</span> 
</span></span><span class="line"><span class="cl"><span class="n">Protocol</span><span class="o">.</span><span class="k">export</span><span class="p">()</span> <span class="err">→</span> <span class="err">启动</span><span class="n">Server</span> <span class="err">→</span> <span class="err">注册到注册中心</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>详细步骤：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 1. Spring扫描@DubboService注解，创建ServiceBean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 2. ServiceConfig.export()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">export</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2.1 检查配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">checkAndUpdateSubConfigs</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2.2 构建URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">URL</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2.3 通过Protocol暴露服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Exporter</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">exporter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">protocol</span><span class="p">.</span><span class="na">export</span><span class="p">(</span><span class="n">invoker</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2.4 注册到注册中心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">registry</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">url</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 3. Protocol.export() - 以Triple协议为例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Exporter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">invoker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 启动HTTP/2 Server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">openServer</span><span class="p">(</span><span class="n">url</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TripleExporter</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">invoker</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Q: Dubbo的服务引用过程是怎样的？</strong></p>
<p><strong>A:</strong> 服务引用的核心流程：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">@DubboReference注解 → ReferenceBean → ReferenceConfig.get() → 
</span></span><span class="line"><span class="cl">Protocol.refer() → 创建代理对象
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>详细步骤：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 1. Spring扫描@DubboReference注解</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboReference</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 2. ReferenceConfig.get()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">get</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2.1 从注册中心订阅服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span><span class="w"> </span><span class="n">urls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registry</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="n">url</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2.2 创建Invoker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Invoker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">invoker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">protocol</span><span class="p">.</span><span class="na">refer</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2.3 创建代理对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">proxyFactory</span><span class="p">.</span><span class="na">getProxy</span><span class="p">(</span><span class="n">invoker</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="26-dubbo高级特性">2.6 Dubbo高级特性
</h3><p><strong>Q: Dubbo如何实现服务分组和多版本？</strong></p>
<p><strong>A:</strong> 通过group和version参数实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 服务提供者 - 不同分组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboService</span><span class="p">(</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;primary&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PrimaryUserServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboService</span><span class="p">(</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;backup&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BackupUserServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 服务消费者 - 指定分组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboReference</span><span class="p">(</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;primary&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">primaryUserService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 多版本共存</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboService</span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;1.0.0&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserServiceV1Impl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboService</span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;2.0.0&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserServiceV2Impl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 消费者指定版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboReference</span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;2.0.0&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 消费者随机调用任意版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboReference</span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;*&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>使用场景：</strong></p>
<ul>
<li><strong>分组</strong>：同一接口的不同实现（如主备、读写分离）</li>
<li><strong>版本</strong>：接口升级时的灰度发布</li>
</ul>
<p><strong>Q: Dubbo的隐式参数传递是怎么实现的？</strong></p>
<p><strong>A:</strong> 通过RpcContext传递隐式参数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// Consumer端设置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">RpcContext</span><span class="p">.</span><span class="na">getClientAttachment</span><span class="p">().</span><span class="na">setAttachment</span><span class="p">(</span><span class="s">&#34;traceId&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;123456&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">RpcContext</span><span class="p">.</span><span class="na">getClientAttachment</span><span class="p">().</span><span class="na">setAttachment</span><span class="p">(</span><span class="s">&#34;userId&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;1001&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 调用服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">userService</span><span class="p">.</span><span class="na">getById</span><span class="p">(</span><span class="n">1L</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// Provider端获取</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">traceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RpcContext</span><span class="p">.</span><span class="na">getServerAttachment</span><span class="p">().</span><span class="na">getAttachment</span><span class="p">(</span><span class="s">&#34;traceId&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RpcContext</span><span class="p">.</span><span class="na">getServerAttachment</span><span class="p">().</span><span class="na">getAttachment</span><span class="p">(</span><span class="s">&#34;userId&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>应用场景：</strong></p>
<ul>
<li>分布式链路追踪（TraceId传递）</li>
<li>用户身份信息传递</li>
<li>灰度标签传递</li>
</ul>
<p><strong>Q: Dubbo如何实现本地存根（Stub）和本地伪装（Mock）？</strong></p>
<p><strong>A:</strong></p>
<p><strong>本地存根（Stub）- 在Consumer端做预处理：</strong></p>
<p>如果校验不通过，直接返回，而不是去调用rpc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 存根实现</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserServiceStub</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">UserServiceStub</span><span class="p">(</span><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">userService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">getById</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 前置校验</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 调用远程服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">userService</span><span class="p">.</span><span class="na">getById</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboReference</span><span class="p">(</span><span class="n">stub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;com.lucius.eduAgentX.stub.UserServiceStub&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>本地伪装（Mock）- 服务降级：</strong></p>
<p>如果服务炸了，返回默认字符串，如”服务繁忙“，或者可以不管服务器好坏，直接降级返回</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// Mock实现</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserServiceMock</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">getById</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 返回默认值或从缓存获取</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">setUserName</span><span class="p">(</span><span class="s">&#34;默认用户&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 配置 - 失败时Mock</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboReference</span><span class="p">(</span><span class="n">mock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;com.lucius.eduAgentX.mock.UserServiceMock&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 配置 - 强制Mock（不调用远程）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboReference</span><span class="p">(</span><span class="n">mock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;force:com.lucius.eduAgentX.mock.UserServiceMock&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Q: Dubbo的连接控制是怎样的？</strong></p>
<p><strong>A:</strong> Dubbo支持多种连接控制策略：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">dubbo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#作为服务端的时候</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 服务端最大连接数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">accepts</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 每个服务的线程数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">threads</span><span class="p">:</span><span class="w"> </span><span class="m">200</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 线程池类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">threadpool</span><span class="p">:</span><span class="w"> </span><span class="l">fixed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#作为客户端的时候，和服务端建立的连接数量取决于端口数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">consumer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 每个服务的连接数，这里指的是一个服务和一个客户端之间最大连接数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">connections</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 是否共享连接</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">shareconnections</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>连接模式：</strong></p>
<ul>
<li><strong>单一长连接</strong>（默认）：所有请求复用一个连接</li>
<li><strong>多连接</strong>：每个服务建立多个连接，提高并发</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 为特定服务配置多连接</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@DubboReference</span><span class="p">(</span><span class="n">connections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">10</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Q: Dubbo如何处理大数据量传输？</strong></p>
<p><strong>A:</strong></p>
<p><strong>1. 分页查询：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 避免一次返回大量数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Page</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">listByPage</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pageNum</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pageSize</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2. 流式传输（Triple协议支持）：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 服务端流</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">listAllUsers</span><span class="p">(</span><span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">responseObserver</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3. 调整payload限制：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">dubbo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">protocol</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="m">8388608</span><span class="w">  </span><span class="c"># 8MB，默认是8MB</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>4. 压缩传输：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">dubbo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">payload</span><span class="p">:</span><span class="w"> </span><span class="m">8388608</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">protocol</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 启用压缩</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">compressor</span><span class="p">:</span><span class="w"> </span><span class="l">gzip</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Q: Dubbo的服务治理有哪些功能？</strong></p>
<p><strong>A:</strong></p>
<p><strong>1. 动态配置：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 通过Admin或API动态修改配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">ConfigCenterConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConfigCenterConfig</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">config</span><span class="p">.</span><span class="na">setAddress</span><span class="p">(</span><span class="s">&#34;nacos://127.0.0.1:8848&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 动态修改超时时间、权重等</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2. 服务降级：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 通过规则配置降级</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">override</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l">com.lucius.eduAgentX.service.UserService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mock</span><span class="p">:</span><span class="w"> </span><span class="l">force:return null</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3. 访问控制：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 黑白名单</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">accesslog</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l">com.lucius.eduAgentX.service.UserService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">whitelist</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">192.168.1</span><span class="l">.*]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">blacklist</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">192.168.2</span><span class="l">.*]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>4. 权重调整：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 动态调整权重</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">override</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l">com.lucius.eduAgentX.service.UserService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.1.100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">200</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Q: Dubbo 3.x相比2.x有哪些重要变化？</strong></p>
<p><strong>A:</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>特性</th>
          <th>Dubbo 2.x</th>
          <th>Dubbo 3.x</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>服务发现</td>
          <td>接口级</td>
          <td>应用级（默认）</td>
      </tr>
      <tr>
          <td>协议</td>
          <td>Dubbo协议</td>
          <td>Triple协议（默认）</td>
      </tr>
      <tr>
          <td>注册中心</td>
          <td>Zookeeper为主</td>
          <td>Nacos/Zookeeper</td>
      </tr>
      <tr>
          <td>云原生</td>
          <td>不支持</td>
          <td>支持K8s、Service Mesh</td>
      </tr>
      <tr>
          <td>性能</td>
          <td>高</td>
          <td>更高</td>
      </tr>
  </tbody>
</table></div>
<p><strong>应用级服务发现的优势：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">接口级：每个接口都注册一条记录
</span></span><span class="line"><span class="cl">  - UserService → provider1, provider2
</span></span><span class="line"><span class="cl">  - OrderService → provider1, provider2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">应用级：每个应用只注册一条记录
</span></span><span class="line"><span class="cl">  - user-service → provider1, provider2
</span></span><span class="line"><span class="cl">  - 元数据单独存储
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>减少注册中心压力</li>
<li>更适合大规模微服务</li>
<li>与K8s服务发现模型一致</li>
</ul>
<p><strong>Q: 如何排查Dubbo调用问题？</strong></p>
<p><strong>A:</strong></p>
<p><strong>1. 开启访问日志：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">dubbo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">accesslog</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># 或指定文件路径</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2. 查看调用统计：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 通过QoS命令</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">telnet</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="n">22222</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="w"> </span><span class="n">ls</span><span class="w">  </span><span class="c1">// 列出服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">UserService</span><span class="w">  </span><span class="c1">// 查看调用统计</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3. 链路追踪：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 集成SkyWalking或Zipkin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 通过Filter传递TraceId</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>4. 常见问题排查：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">问题：No provider available
</span></span><span class="line"><span class="cl">排查：
</span></span><span class="line"><span class="cl">1. 检查服务是否启动
</span></span><span class="line"><span class="cl">2. 检查注册中心连接
</span></span><span class="line"><span class="cl">3. 检查group/version是否匹配
</span></span><span class="line"><span class="cl">4. 检查网络是否通畅
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">问题：Timeout
</span></span><span class="line"><span class="cl">排查：
</span></span><span class="line"><span class="cl">1. 检查Provider处理时间
</span></span><span class="line"><span class="cl">2. 检查网络延迟
</span></span><span class="line"><span class="cl">3. 调整timeout配置
</span></span><span class="line"><span class="cl">4. 检查线程池是否满了
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="三高并发抢课系统">三、高并发抢课系统
</h2><h3 id="31-抢课核心流程">3.1 抢课核心流程
</h3><p><strong>Q: 抢课系统的核心流程是怎样的？</strong></p>
<p><strong>A:</strong> 采用 <strong>Redis预扣库存 + 异步落库</strong> 的架构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">用户请求 → 限流检查 → Lua脚本原子操作 → 返回结果
</span></span><span class="line"><span class="cl">                           ↓
</span></span><span class="line"><span class="cl">                    临时数据写入Redis
</span></span><span class="line"><span class="cl">                           ↓
</span></span><span class="line"><span class="cl">                    定时任务批量同步到MySQL
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>核心代码：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">snatchTheSubject</span><span class="p">(</span><span class="n">SnatchRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">httpRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">loginUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userService</span><span class="p">.</span><span class="na">getLoginUser</span><span class="p">(</span><span class="n">httpRequest</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Long</span><span class="w"> </span><span class="n">studentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loginUser</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Long</span><span class="w"> </span><span class="n">subjectId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSubjectId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 检查Redis中是否有课程容量数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snatchCacheService</span><span class="p">.</span><span class="na">getSubjectCapacityWithCache</span><span class="p">(</span><span class="n">subjectId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capacity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">snatchSubjectService</span><span class="p">.</span><span class="na">initSubjectCapacityToRedis</span><span class="p">(</span><span class="n">subjectId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 执行Lua脚本抢课</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Long</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snatchCacheService</span><span class="p">.</span><span class="na">snatchWithCache</span><span class="p">(</span><span class="n">studentId</span><span class="p">,</span><span class="w"> </span><span class="n">subjectId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 处理返回结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ErrorCode</span><span class="p">.</span><span class="na">OPERATION_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;已抢课，不能重复抢课&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ErrorCode</span><span class="p">.</span><span class="na">OPERATION_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;课程余量不足&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResultUtils</span><span class="p">.</span><span class="na">success</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ErrorCode</span><span class="p">.</span><span class="na">SYSTEM_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;抢课失败&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Redis数据结构设计：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">subject:capacity          # Hash: 课程容量
</span></span><span class="line"><span class="cl">  ├── 1 → 100
</span></span><span class="line"><span class="cl">  └── 2 → 50
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">snatch:{studentId}        # Hash: 学生已抢课程
</span></span><span class="line"><span class="cl">  ├── 1 → 1
</span></span><span class="line"><span class="cl">  └── 3 → 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">snatch:temp:{timeSlice}   # Hash: 临时抢课数据
</span></span><span class="line"><span class="cl">  ├── 1001:1 → 1          # 学生1001抢了课程1
</span></span><span class="line"><span class="cl">  └── 1002:1 → -1         # 学生1002退了课程1
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>深入追问：</strong></p>
<p><strong>Q: 为什么不直接写MySQL？</strong> A:</p>
<ul>
<li>MySQL单机QPS约1000，无法支撑高并发</li>
<li>Redis单机QPS可达10万+</li>
<li>异步落库减少数据库压力</li>
</ul>
<hr>
<h3 id="32-数据一致性保证">3.2 数据一致性保证
</h3><p><strong>Q: Redis和MySQL的数据一致性怎么保证？</strong></p>
<p><strong>A:</strong> 通过 <strong>定时任务 + 补偿机制</strong> 保证最终一致性：</p>
<p><strong>定时同步任务（每10秒执行）：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">fixedRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">10000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Transactional</span><span class="p">(</span><span class="n">rollbackFor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">lastTimeSlice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RedisKeyUtil</span><span class="p">.</span><span class="na">getLastTimeSlice</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">syncSnatch2DBByTimeSlice</span><span class="p">(</span><span class="n">lastTimeSlice</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">syncSnatch2DBByTimeSlice</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">timeSlice</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">tempSnatchKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RedisKeyUtil</span><span class="p">.</span><span class="na">getTempSnatchKey</span><span class="p">(</span><span class="n">timeSlice</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allTempSnatchMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForHash</span><span class="p">().</span><span class="na">entries</span><span class="p">(</span><span class="n">tempSnatchKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Snatch</span><span class="o">&gt;</span><span class="w"> </span><span class="n">snatchListToInsert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Snatch</span><span class="o">&gt;</span><span class="w"> </span><span class="n">snatchListToDelete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">allTempSnatchMap</span><span class="p">.</span><span class="na">keySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">parts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">studentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">parts</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">subjectId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">parts</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">snatchType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">allTempSnatchMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">snatchType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 抢课</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">snatchListToInsert</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Snatch</span><span class="p">(</span><span class="n">studentId</span><span class="p">,</span><span class="w"> </span><span class="n">subjectId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">snatchType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 退课</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">snatchListToDelete</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Snatch</span><span class="p">(</span><span class="n">studentId</span><span class="p">,</span><span class="w"> </span><span class="n">subjectId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 批量操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">snatchListToInsert</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">snatchService</span><span class="p">.</span><span class="na">saveBatch</span><span class="p">(</span><span class="n">snatchListToInsert</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>补偿任务（每天凌晨2点）：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;0 0 2 * * *&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">snatchKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">keys</span><span class="p">(</span><span class="s">&#34;snatch:temp:*&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">timeSlice</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">extractTimeSlices</span><span class="p">(</span><span class="n">snatchKeys</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">syncSnatch2DBJob</span><span class="p">.</span><span class="na">syncSnatch2DBByTimeSlice</span><span class="p">(</span><span class="n">timeSlice</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>时间片设计：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getCurrentTimeSlice</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Date</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateUtil</span><span class="p">.</span><span class="na">second</span><span class="p">(</span><span class="n">now</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">alignedSecond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">second</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">10</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w">  </span><span class="c1">// 向下取整到10的倍数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">DateUtil</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;HH:mm:&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;%02d&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">alignedSecond</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 例如：14:30:00, 14:30:10, 14:30:20...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="33-限流实现">3.3 限流实现
</h3><p><strong>Q: 接口限流是怎么实现的？</strong></p>
<p><strong>A:</strong> 使用 <strong>Redis + Lua脚本</strong> 实现滑动窗口限流：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Aspect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RateLimitAspect</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">DefaultRedisScript</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RATE_LIMIT_SCRIPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultRedisScript</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">        local key = KEYS[1]
</span></span></span><span class="line"><span class="cl"><span class="s">        local window = tonumber(ARGV[1])
</span></span></span><span class="line"><span class="cl"><span class="s">        local limit = tonumber(ARGV[2])
</span></span></span><span class="line"><span class="cl"><span class="s">        local current = tonumber(ARGV[3])
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">        -- 移除窗口外的记录
</span></span></span><span class="line"><span class="cl"><span class="s">        redis.call(&#39;ZREMRANGEBYSCORE&#39;, key, 0, current - window * 1000)
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">        -- 统计当前窗口内的请求数
</span></span></span><span class="line"><span class="cl"><span class="s">        local currentCount = redis.call(&#39;ZCARD&#39;, key)
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">        if currentCount &lt; limit then
</span></span></span><span class="line"><span class="cl"><span class="s">            -- 未超限，记录本次请求
</span></span></span><span class="line"><span class="cl"><span class="s">            redis.call(&#39;ZADD&#39;, key, current, current)
</span></span></span><span class="line"><span class="cl"><span class="s">            redis.call(&#39;EXPIRE&#39;, key, window)
</span></span></span><span class="line"><span class="cl"><span class="s">            return limit - currentCount - 1  -- 返回剩余次数
</span></span></span><span class="line"><span class="cl"><span class="s">        else
</span></span></span><span class="line"><span class="cl"><span class="s">            return -1  -- 超限
</span></span></span><span class="line"><span class="cl"><span class="s">        end
</span></span></span><span class="line"><span class="cl"><span class="s">        &#34;&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Around</span><span class="p">(</span><span class="s">&#34;@annotation(rateLimit)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">around</span><span class="p">(</span><span class="n">ProceedingJoinPoint</span><span class="w"> </span><span class="n">point</span><span class="p">,</span><span class="w"> </span><span class="n">RateLimit</span><span class="w"> </span><span class="n">rateLimit</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">limitKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buildLimitKey</span><span class="p">(</span><span class="n">rateLimit</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">RATE_LIMIT_SCRIPT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Collections</span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="n">limitKey</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">rateLimit</span><span class="p">.</span><span class="na">window</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">rateLimit</span><span class="p">.</span><span class="na">limit</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remaining</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ErrorCode</span><span class="p">.</span><span class="na">OPERATION_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;操作过于频繁，请稍后重试&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>使用方式：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RateLimit</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;snatch&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;user&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&#34;/save&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">snatchTheSubject</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">SnatchRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>深入追问：</strong></p>
<p><strong>Q: 为什么用滑动窗口而不是固定窗口？</strong> A: 固定窗口在窗口边界会有突刺问题。比如限制每秒5次，在0.9秒请求5次，1.1秒又请求5次，实际0.2秒内请求了10次。滑动窗口能更平滑地限流。</p>
<hr>
<h3 id="34-性能优化措施">3.4 性能优化措施
</h3><p><strong>Q: 抢课系统做了哪些性能优化？</strong></p>
<p><strong>A:</strong> 主要优化措施：</p>
<p><strong>1. 连接池优化：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lettuce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">max-active</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">    </span><span class="c"># 最大连接数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">max-idle</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">min-idle</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hikari</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maximum-pool-size</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">minimum-idle</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tomcat</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">threads</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">min-spare</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">max-connections</span><span class="p">:</span><span class="w"> </span><span class="m">10000</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2. Lua脚本优化：</strong></p>
<ul>
<li>减少Redis操作次数（原来5次→现在3次）</li>
<li>使用HINCRBY原子操作</li>
</ul>
<p><strong>3. 批量SQL优化：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 使用CASE WHEN批量更新</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Update</span><span class="p">(</span><span class="s">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    UPDATE snatch_subject 
</span></span></span><span class="line"><span class="cl"><span class="s">    SET capacity = CASE subject_id 
</span></span></span><span class="line"><span class="cl"><span class="s">        &lt;foreach collection=&#34;list&#34; item=&#34;item&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s">            WHEN #{item.subjectId} THEN capacity + #{item.change}
</span></span></span><span class="line"><span class="cl"><span class="s">        &lt;/foreach&gt;
</span></span></span><span class="line"><span class="cl"><span class="s">    END
</span></span></span><span class="line"><span class="cl"><span class="s">    WHERE subject_id IN 
</span></span></span><span class="line"><span class="cl"><span class="s">        &lt;foreach collection=&#34;list&#34; item=&#34;item&#34; open=&#34;(&#34; separator=&#34;,&#34; close=&#34;)&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s">            #{item.subjectId}
</span></span></span><span class="line"><span class="cl"><span class="s">        &lt;/foreach&gt;
</span></span></span><span class="line"><span class="cl"><span class="s">&#34;&#34;&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="w"> </span><span class="nf">batchUpdateSubjectCapacity</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&#34;list&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SubjectCapacityChangeDTO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>4. 异步热Key检测：</strong></p>
<ul>
<li>HeavyKeeper的add()操作异步执行</li>
<li>不阻塞主流程</li>
</ul>
<p><strong>性能对比：</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>指标</th>
          <th>优化前</th>
          <th>优化后</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>QPS</td>
          <td>500</td>
          <td>2000+</td>
      </tr>
      <tr>
          <td>响应时间</td>
          <td>100ms</td>
          <td>&lt;50ms</td>
      </tr>
      <tr>
          <td>Redis连接数</td>
          <td>10</td>
          <td>100</td>
      </tr>
  </tbody>
</table></div>
<hr>
<h2 id="四ai工作流系统">四、AI工作流系统
</h2><h3 id="41-langgraph4j工作流">4.1 LangGraph4j工作流
</h3><p><strong>Q: AI出题的工作流是怎么设计的？</strong></p>
<p><strong>A:</strong> 使用LangGraph4j构建有向图工作流，支持条件路由和循环：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">CompiledGraph</span><span class="o">&lt;</span><span class="n">MessagesState</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">createQuestionWorkflow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MessagesStateGraph</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 添加节点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;ques_knowledge_result_node&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">QuesKnowledgeResultNode</span><span class="p">.</span><span class="na">create</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;ques_task_list_node&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">QuesTaskListNode</span><span class="p">.</span><span class="na">create</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;ques_generate_node&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">QuesGenerateNode</span><span class="p">.</span><span class="na">create</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;ques_parse_check_node&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">QuesParseCheckNode</span><span class="p">.</span><span class="na">create</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 添加边</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ques_knowledge_result_node&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;ques_knowledge_result_node&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ques_task_list_node&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;ques_task_list_node&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ques_generate_node&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;ques_generate_node&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ques_parse_check_node&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 条件路由</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addConditionalEdges</span><span class="p">(</span><span class="s">&#34;ques_parse_check_node&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">edge_async</span><span class="p">(</span><span class="k">this</span><span class="p">::</span><span class="n">routeAfterCheck</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;continue_generate&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ques_generate_node&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;retry_generate&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ques_generate_node&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;finish&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">compile</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">routeAfterCheck</span><span class="p">(</span><span class="n">MessagesState</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">QuestionGenerateContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QuestionGenerateContext</span><span class="p">.</span><span class="na">getContext</span><span class="p">(</span><span class="n">state</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Boolean</span><span class="w"> </span><span class="n">checkResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getCheckResult</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">checkResult</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;retry_generate&#34;</span><span class="p">;</span><span class="w">  </span><span class="c1">// 质检未通过，重新生成</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">context</span><span class="p">.</span><span class="na">setCurrentQuestionIndex</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">getCurrentQuestionIndex</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">getQuestionNum</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;continue_generate&#34;</span><span class="p">;</span><span class="w">  </span><span class="c1">// 继续生成下一题</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;finish&#34;</span><span class="p">;</span><span class="w">  </span><span class="c1">// 完成</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>工作流图：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">graph LR
</span></span><span class="line"><span class="cl">    START --&gt; 知识点检索
</span></span><span class="line"><span class="cl">    知识点检索 --&gt; 任务列表生成
</span></span><span class="line"><span class="cl">    任务列表生成 --&gt; 题目生成
</span></span><span class="line"><span class="cl">    题目生成 --&gt; 质检解析
</span></span><span class="line"><span class="cl">    质检解析 --&gt;|通过且有剩余| 题目生成
</span></span><span class="line"><span class="cl">    质检解析 --&gt;|未通过| 题目生成
</span></span><span class="line"><span class="cl">    质检解析 --&gt;|完成| END
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="42-设计模式应用">4.2 设计模式应用
</h3><p><strong>Q: AI出题系统用了哪些设计模式？</strong></p>
<p><strong>A:</strong> 主要使用了三种设计模式：</p>
<p><strong>1. 外观模式（Facade）：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AIQuestionFacade</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">QuestionMakerService</span><span class="w"> </span><span class="n">questionMakerService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ExplanationExecutor</span><span class="w"> </span><span class="n">explanationExecutor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ScoreStandardExecutor</span><span class="w"> </span><span class="n">scoreStandardExecutor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">QuestionGenerateContext</span><span class="w"> </span><span class="nf">generateAndParseQuestion</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">SseEmitter</span><span class="w"> </span><span class="n">emitter</span><span class="p">,</span><span class="w"> </span><span class="n">QuestionGenerateContext</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">prompt</span><span class="p">,</span><span class="w"> </span><span class="n">QuestionTypeEnum</span><span class="w"> </span><span class="n">questionTypeEnum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">questionTypeEnum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">MULTIPLE_CHOICE_QUESTION</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">questionMakerService</span><span class="p">.</span><span class="na">multipleChoiceQuestion</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span><span class="w"> </span><span class="n">subjectId</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">yield</span><span class="w"> </span><span class="nf">processQuestionStream</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">questionTypeEnum</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">FILL_BLANK_QUESTION</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">questionMakerService</span><span class="p">.</span><span class="na">fillBlankQuestion</span><span class="p">(</span><span class="n">subjectId</span><span class="p">,</span><span class="w"> </span><span class="n">prompt</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">yield</span><span class="w"> </span><span class="nf">processQuestionStream</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">questionTypeEnum</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">BIG_QUESTION</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">questionMakerService</span><span class="p">.</span><span class="na">bigQuestion</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">,</span><span class="w"> </span><span class="n">subjectId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">yield</span><span class="w"> </span><span class="nf">processQuestionStream</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">questionTypeEnum</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2. 模板方法模式：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ParseCheckStorageExecutor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">MultipleChoiceStorageTemplate</span><span class="w"> </span><span class="n">multipleChoiceStorageTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">FillBlankStorageTemplate</span><span class="w"> </span><span class="n">fillBlankStorageTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigStorageTemplate</span><span class="w"> </span><span class="n">bigStorageTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">QuestionGenerateContext</span><span class="w"> </span><span class="nf">executeParseCheckAndStorage</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">questionResult</span><span class="p">,</span><span class="w"> </span><span class="n">QuestionGenerateContext</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">QuestionTypeEnum</span><span class="w"> </span><span class="n">questionTypeEnum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">questionTypeEnum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">MULTIPLE_CHOICE_QUESTION</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">multipleChoiceStorageTemplate</span><span class="p">.</span><span class="na">saveQuestion</span><span class="p">((</span><span class="n">MultipleChoiceQuestionBO</span><span class="p">)</span><span class="w"> </span><span class="n">questionResult</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">FILL_BLANK_QUESTION</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">fillBlankStorageTemplate</span><span class="p">.</span><span class="na">saveQuestion</span><span class="p">((</span><span class="n">FillBlankQuestionBO</span><span class="p">)</span><span class="w"> </span><span class="n">questionResult</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">BIG_QUESTION</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">bigStorageTemplate</span><span class="p">.</span><span class="na">saveQuestion</span><span class="p">((</span><span class="n">BigQuestionBO</span><span class="p">)</span><span class="w"> </span><span class="n">questionResult</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3. 策略模式：</strong></p>
<ul>
<li>不同题型使用不同的生成策略</li>
<li>不同题型使用不同的解析策略</li>
<li>不同题型使用不同的评分标准生成策略</li>
</ul>
<hr>
<h3 id="43-sse实时推送">4.3 SSE实时推送
</h3><p><strong>Q: AI生成过程中的实时推送是怎么实现的？</strong></p>
<p><strong>A:</strong> 使用SSE（Server-Sent Events）+ ThreadLocal存储Emitter：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WorkFlowServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">WorkFlowService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">SseEmitter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SSE_EMITTER_HOLDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadLocal</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="nf">generateQuestionWorkFlow</span><span class="p">(...,</span><span class="w"> </span><span class="n">SseEmitter</span><span class="w"> </span><span class="n">emitter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SSE_EMITTER_HOLDER</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">emitter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 发送初始消息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">JSONObject</span><span class="w"> </span><span class="n">jsonObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JSONObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">jsonObject</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">WorkFlowTagEnum</span><span class="p">.</span><span class="na">START</span><span class="p">.</span><span class="na">getValue</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;工作流开始执行...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">SseEmitter</span><span class="p">.</span><span class="na">event</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">name</span><span class="p">(</span><span class="n">WorkFlowTagEnum</span><span class="p">.</span><span class="na">START</span><span class="p">.</span><span class="na">getValue</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">data</span><span class="p">(</span><span class="n">jsonObject</span><span class="p">.</span><span class="na">toString</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">CompiledGraph</span><span class="o">&lt;</span><span class="n">MessagesState</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">workflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createQuestionWorkflow</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 异步执行工作流</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">runAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">SSE_EMITTER_HOLDER</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">emitter</span><span class="p">);</span><span class="w">  </span><span class="c1">// 异步线程重新设置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">NodeOutput</span><span class="o">&lt;</span><span class="n">MessagesState</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">workflow</span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="n">initialState</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="c1">// 节点内部实时发送SSE消息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">emitter</span><span class="p">.</span><span class="na">complete</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">emitter</span><span class="p">.</span><span class="na">completeWithError</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">SSE_EMITTER_HOLDER</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 主线程不清理，异步任务会重新设置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>节点中发送消息：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">QuesGenerateNode</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AsyncNodeAction</span><span class="o">&lt;</span><span class="n">MessagesState</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">create</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">SseEmitter</span><span class="w"> </span><span class="n">emitter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSE_EMITTER_HOLDER</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">JSONObject</span><span class="w"> </span><span class="n">jsonObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JSONObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">jsonObject</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">WorkFlowTagEnum</span><span class="p">.</span><span class="na">ALERT</span><span class="p">.</span><span class="na">getValue</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;题目生成节点&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">SseEmitter</span><span class="p">.</span><span class="na">event</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">name</span><span class="p">(</span><span class="n">WorkFlowTagEnum</span><span class="p">.</span><span class="na">ALERT</span><span class="p">.</span><span class="na">getValue</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">data</span><span class="p">(</span><span class="n">jsonObject</span><span class="p">.</span><span class="na">toString</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 生成题目...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">QuestionGenerateContext</span><span class="p">.</span><span class="na">saveContext</span><span class="p">(</span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>深入追问：</strong></p>
<p><strong>Q: 为什么用ThreadLocal存储SseEmitter？</strong> A:</p>
<ul>
<li>SseEmitter不能序列化，无法放入工作流状态</li>
<li>ThreadLocal可以在同一线程的不同节点间共享</li>
<li>异步线程需要重新设置</li>
</ul>
<hr>
<h3 id="44-rag检索增强">4.4 RAG检索增强
</h3><p><strong>Q: RAG是怎么实现的？</strong></p>
<p><strong>A:</strong> 使用Spring AI + Redis向量存储：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ai</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">openai</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">base-url</span><span class="p">:</span><span class="w"> </span><span class="l">${spring.ai.openai.base-url}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">api-key</span><span class="p">:</span><span class="w"> </span><span class="l">${spring.ai.openai.api-key}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">embedding</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">options</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l">text-embedding-v3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="m">1024</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>文档处理流程：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">RagService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 文档上传并向量化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Long</span><span class="w"> </span><span class="nf">documentPush</span><span class="p">(</span><span class="n">MultipartFile</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">category</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">subjectId</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 检索相关内容</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">RagResultVO</span><span class="w"> </span><span class="nf">getRagResult</span><span class="p">(</span><span class="n">RagPromptRequest</span><span class="w"> </span><span class="n">request</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 删除文档</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">deleteDocumentByFileId</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>支持的文档格式：</strong></p>
<ul>
<li>PDF（使用spring-ai-pdf-document-reader）</li>
<li>DOCX（使用Apache POI）</li>
</ul>
<hr>
<h2 id="五数据库与orm">五、数据库与ORM
</h2><h3 id="51-mybatis-flex使用">5.1 MyBatis-Flex使用
</h3><p><strong>Q: 为什么选择MyBatis-Flex而不是MyBatis-Plus？</strong></p>
<p><strong>A:</strong> MyBatis-Flex是MyBatis-Plus的轻量级替代：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// QueryWrapper使用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">QueryWrapper</span><span class="w"> </span><span class="nf">getQueryWrapper</span><span class="p">(</span><span class="n">UserQueryRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">QueryWrapper</span><span class="p">.</span><span class="na">create</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="s">&#34;userRole&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getUserRole</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">like</span><span class="p">(</span><span class="s">&#34;userAccount&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getUserAccount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">like</span><span class="p">(</span><span class="s">&#34;userName&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getUserName</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">orderBy</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getSortField</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;ascend&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getSortOrder</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 条件更新</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">QueryWrapper</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QueryWrapper</span><span class="p">.</span><span class="na">create</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">where</span><span class="p">(</span><span class="n">User</span><span class="p">::</span><span class="n">getId</span><span class="p">).</span><span class="na">eq</span><span class="p">(</span><span class="n">loginUser</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">userMapper</span><span class="p">.</span><span class="na">updateByQuery</span><span class="p">(</span><span class="n">updateUser</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>对比MyBatis-Plus：</strong> | 特性 | MyBatis-Flex | MyBatis-Plus |
|&mdash;&mdash;|&mdash;&mdash;&mdash;&mdash;-|&mdash;&mdash;&mdash;&mdash;&ndash;|
| 依赖大小 | 更小 | 较大 |
| Lambda支持 | 支持 | 支持 |
| 多表关联 | 更好 | 一般 |
| 学习成本 | 低 | 低 |</p>
<hr>
<h3 id="52-批量操作优化">5.2 批量操作优化
</h3><p><strong>Q: 批量更新是怎么优化的？</strong></p>
<p><strong>A:</strong> 使用CASE WHEN语句一次SQL更新多条记录：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&#34;batchUpdateSubjectCapacity&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    UPDATE snatch_subject 
</span></span><span class="line"><span class="cl">    SET capacity = CASE subject_id 
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;foreach</span> <span class="na">collection=</span><span class="s">&#34;list&#34;</span> <span class="na">item=</span><span class="s">&#34;item&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">            WHEN #{item.subjectId} THEN capacity + #{item.change}
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/foreach&gt;</span>
</span></span><span class="line"><span class="cl">    END
</span></span><span class="line"><span class="cl">    WHERE subject_id IN 
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;foreach</span> <span class="na">collection=</span><span class="s">&#34;list&#34;</span> <span class="na">item=</span><span class="s">&#34;item&#34;</span> <span class="na">open=</span><span class="s">&#34;(&#34;</span> <span class="na">separator=</span><span class="s">&#34;,&#34;</span> <span class="na">close=</span><span class="s">&#34;)&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">            #{item.subjectId}
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/foreach&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/update&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>对比逐条更新：</strong></p>
<ul>
<li>逐条更新：N次网络往返 + N次SQL解析</li>
<li>批量更新：1次网络往返 + 1次SQL解析</li>
</ul>
<hr>
<h3 id="53-连接池配置">5.3 连接池配置
</h3><p><strong>Q: HikariCP是怎么配置的？</strong></p>
<p><strong>A:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hikari</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maximum-pool-size</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">      </span><span class="c"># 最大连接数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">minimum-idle</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">           </span><span class="c"># 最小空闲连接</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">connection-timeout</span><span class="p">:</span><span class="w"> </span><span class="m">30000</span><span class="w">  </span><span class="c"># 连接超时30秒</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">idle-timeout</span><span class="p">:</span><span class="w"> </span><span class="m">600000</span><span class="w">       </span><span class="c"># 空闲超时10分钟</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max-lifetime</span><span class="p">:</span><span class="w"> </span><span class="m">1800000</span><span class="w">      </span><span class="c"># 最大生命周期30分钟</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>参数调优原则：</strong></p>
<ul>
<li><code>maximum-pool-size</code>: 根据并发量和数据库承载能力设置</li>
<li><code>minimum-idle</code>: 保持一定空闲连接，减少创建开销</li>
<li><code>max-lifetime</code>: 小于数据库的wait_timeout</li>
</ul>
<hr>
<h3 id="54-事务管理">5.4 事务管理
</h3><p><strong>Q: 事务是怎么管理的？</strong></p>
<p><strong>A:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">fixedRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">10000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Transactional</span><span class="p">(</span><span class="n">rollbackFor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 批量插入、删除、更新</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 任何异常都会回滚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>rollbackFor = Exception.class的作用：</strong></p>
<ul>
<li>默认只对RuntimeException回滚</li>
<li>设置后对所有Exception都回滚</li>
</ul>
<hr>
<h2 id="六安全与认证">六、安全与认证
</h2><h3 id="61-密码加密">6.1 密码加密
</h3><p><strong>Q: 密码是怎么加密的？</strong></p>
<p><strong>A:</strong> 使用MD5 + 盐值加密：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEncryptPassword</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userPassword</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">SALT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;lucius&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">DigestUtils</span><span class="p">.</span><span class="na">md5DigestAsHex</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="n">userPassword</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SALT</span><span class="p">).</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>深入追问：</strong></p>
<p><strong>Q: MD5安全吗？有什么改进方案？</strong> A: MD5已不够安全，可以改进为：</p>
<ul>
<li>BCrypt（推荐）</li>
<li>PBKDF2</li>
<li>Argon2</li>
</ul>
<hr>
<h3 id="62-权限控制">6.2 权限控制
</h3><p><strong>Q: 权限控制是怎么实现的？</strong></p>
<p><strong>A:</strong> 使用AOP切面 + 自定义注解：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Aspect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Around</span><span class="p">(</span><span class="s">&#34;@annotation(authCheck)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">doInterceptor</span><span class="p">(</span><span class="n">ProceedingJoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">,</span><span class="w"> </span><span class="n">AuthCheck</span><span class="w"> </span><span class="n">authCheck</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">mustRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authCheck</span><span class="p">.</span><span class="na">mustRole</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">ServletRequestAttributes</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">currentRequestAttributes</span><span class="p">()).</span><span class="na">getRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">loginUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userService</span><span class="p">.</span><span class="na">getLoginUser</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">UserRoleEnum</span><span class="w"> </span><span class="n">mustRoleEnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserRoleEnum</span><span class="p">.</span><span class="na">getEnumByValue</span><span class="p">(</span><span class="n">mustRole</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mustRoleEnum</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span><span class="w">  </span><span class="c1">// 不需要权限</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">UserRoleEnum</span><span class="w"> </span><span class="n">userRoleEnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserRoleEnum</span><span class="p">.</span><span class="na">getEnumByValue</span><span class="p">(</span><span class="n">loginUser</span><span class="p">.</span><span class="na">getUserRole</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mustRoleEnum</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">userRoleEnum</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ErrorCode</span><span class="p">.</span><span class="na">NO_AUTH_ERROR</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>使用方式：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@AuthCheck</span><span class="p">(</span><span class="n">mustRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;admin&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/list&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">listUsers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 只有admin角色可以访问</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="七rocketmq消息队列">七、RocketMQ消息队列
</h2><h3 id="71-mq选型对比">7.1 MQ选型对比
</h3><p><strong>Q: 为什么选择RocketMQ？</strong></p>
<p><strong>A:</strong> 对比三种主流MQ：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>特性</th>
          <th>RocketMQ</th>
          <th>Kafka</th>
          <th>RabbitMQ</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>吞吐量</td>
          <td>高</td>
          <td>最高</td>
          <td>中等</td>
      </tr>
      <tr>
          <td>延迟</td>
          <td>毫秒级</td>
          <td>毫秒级</td>
          <td>微秒级</td>
      </tr>
      <tr>
          <td>可靠性</td>
          <td>高</td>
          <td>高</td>
          <td>高</td>
      </tr>
      <tr>
          <td>事务消息</td>
          <td>支持</td>
          <td>不支持</td>
          <td>不支持</td>
      </tr>
      <tr>
          <td>顺序消息</td>
          <td>支持</td>
          <td>支持</td>
          <td>支持</td>
      </tr>
      <tr>
          <td>运维复杂度</td>
          <td>中等</td>
          <td>高</td>
          <td>低</td>
      </tr>
  </tbody>
</table></div>
<p><strong>选择RocketMQ原因：</strong></p>
<ul>
<li>阿里开源，国内社区活跃</li>
<li>支持事务消息（抢课场景可能需要）</li>
<li>性能和可靠性平衡好</li>
</ul>
<hr>
<h3 id="72-生产者消费者配置">7.2 生产者/消费者配置
</h3><p><strong>Q: RocketMQ是怎么配置的？</strong></p>
<p><strong>A:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">rocketmq</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name-server</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.5.4</span><span class="p">:</span><span class="m">8081</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">topic</span><span class="p">:</span><span class="w"> </span><span class="l">snatch-topic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">producer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">snatch-producer-group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">send-message-timeout</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">retry-times-when-send-failed</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">consumer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">snatch-consumer-group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">batch-size</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">        </span><span class="c"># 批量消费</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">batch-timeout</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">       </span><span class="c"># 批次超时</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pull-batch-size</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">consume-thread-min</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">consume-thread-max</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="八阿里云oss文件存储">八、阿里云OSS文件存储
</h2><h3 id="81-oss配置">8.1 OSS配置
</h3><p><strong>Q: OSS是怎么配置的？</strong></p>
<p><strong>A:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">edu</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">alioss</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="l">${edu.alioss.endpoint}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">access-key-id</span><span class="p">:</span><span class="w"> </span><span class="l">${edu.alioss.access-key-id}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">access-key-secret</span><span class="p">:</span><span class="w"> </span><span class="l">${edu.alioss.access-key-secret}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">bucket-name</span><span class="p">:</span><span class="w"> </span><span class="l">${edu.alioss.bucket-name}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>敏感信息管理：</strong></p>
<ul>
<li>使用环境变量或配置中心</li>
<li>不在代码中硬编码</li>
</ul>
<hr>
<h3 id="82-文件上传流程">8.2 文件上传流程
</h3><p><strong>Q: 文件上传是怎么实现的？</strong></p>
<p><strong>A:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="nf">updateUserAvatar</span><span class="p">(</span><span class="n">MultipartFile</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">loginUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getLoginUser</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 生成唯一文件名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">originalFilename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="na">getOriginalFilename</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalFilename</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">originalFilename</span><span class="p">.</span><span class="na">lastIndexOf</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">snowId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IdUtil</span><span class="p">.</span><span class="na">getSnowflake</span><span class="p">().</span><span class="na">nextIdStr</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">objectName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;user-avatar/&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">snowId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">extension</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 上传到OSS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aliOssUtil</span><span class="p">.</span><span class="na">upload</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(),</span><span class="w"> </span><span class="n">objectName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 更新数据库</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">updateUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">updateUser</span><span class="p">.</span><span class="na">setUserAvatar</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">userMapper</span><span class="p">.</span><span class="na">updateByQuery</span><span class="p">(</span><span class="n">updateUser</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">QueryWrapper</span><span class="p">.</span><span class="na">create</span><span class="p">().</span><span class="na">where</span><span class="p">(</span><span class="n">User</span><span class="p">::</span><span class="n">getId</span><span class="p">).</span><span class="na">eq</span><span class="p">(</span><span class="n">loginUser</span><span class="p">.</span><span class="na">getId</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>雪花ID的作用：</strong></p>
<ul>
<li>保证文件名全局唯一</li>
<li>避免文件覆盖</li>
</ul>
<hr>
<h2 id="九上线运维">九、上线运维
</h2><h3 id="91-多环境配置">9.1 多环境配置
</h3><p><strong>Q: 多环境是怎么管理的？</strong></p>
<p><strong>A:</strong> 使用Spring Profiles：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># application.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">active</span><span class="p">:</span><span class="w"> </span><span class="l">local </span><span class="w"> </span><span class="c"># 或 prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># application-local.yml (开发环境)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://localhost:3306/eduagentxnew</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="m">123456</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># application-prod.yml (生产环境)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://localhost:3306/eduagentxnew</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">eduagentxnew</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">${DB_PASSWORD} </span><span class="w"> </span><span class="c"># 从环境变量读取</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="92-健康检查">9.2 健康检查
</h3><p><strong>Q: 健康检查接口是怎么设计的？</strong></p>
<p><strong>A:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&#34;/health&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HealthController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">healthCheck</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResultUtils</span><span class="p">.</span><span class="na">success</span><span class="p">(</span><span class="s">&#34;ok&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>用途：</strong></p>
<ul>
<li>负载均衡健康探测</li>
<li>K8s存活探针</li>
<li>监控系统检测</li>
</ul>
<hr>
<h3 id="93-缓存监控">9.3 缓存监控
</h3><p><strong>Q: 缓存监控是怎么实现的？</strong></p>
<p><strong>A:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&#34;/admin/cache&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AdminCacheMonitorController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/stats&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;</span><span class="n">CacheStatsVO</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getCacheStats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CacheStats</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">localCache</span><span class="p">.</span><span class="na">stats</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CacheStatsVO</span><span class="w"> </span><span class="n">vo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CacheStatsVO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">vo</span><span class="p">.</span><span class="na">setHitCount</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">hitCount</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">vo</span><span class="p">.</span><span class="na">setMissCount</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">missCount</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">vo</span><span class="p">.</span><span class="na">setHitRate</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">hitRate</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">vo</span><span class="p">.</span><span class="na">setEvictionCount</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">evictionCount</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">vo</span><span class="p">.</span><span class="na">setCacheSize</span><span class="p">(</span><span class="n">localCache</span><span class="p">.</span><span class="na">estimatedSize</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResultUtils</span><span class="p">.</span><span class="na">success</span><span class="p">(</span><span class="n">vo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/hot-subjects&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">getHotSubjects</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResultUtils</span><span class="p">.</span><span class="na">success</span><span class="p">(</span><span class="n">snatchCacheService</span><span class="p">.</span><span class="na">getHotSubjects</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="94-系统初始化">9.4 系统初始化
</h3><p><strong>Q: 应用启动时做了什么初始化？</strong></p>
<p><strong>A:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SnatchInitializer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SnatchSubjectService</span><span class="w"> </span><span class="n">snatchSubjectService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@PostConstruct</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;开始初始化抢课系统...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">snatchSubjectService</span><span class="p">.</span><span class="na">initAllSubjectCapacityToRedis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;抢课系统初始化完成&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;抢课系统初始化失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>初始化内容：</strong></p>
<ul>
<li>将所有课程容量加载到Redis</li>
<li>预热本地缓存</li>
</ul>
<hr>
<h2 id="十异常处理与全局响应">十、异常处理与全局响应
</h2><h3 id="101-统一响应格式">10.1 统一响应格式
</h3><p><strong>Q: 接口响应格式是怎么统一的？</strong></p>
<p><strong>A:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BaseResponse</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">code</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ResultUtils</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">success</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ok&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">error</span><span class="p">(</span><span class="n">ErrorCode</span><span class="w"> </span><span class="n">errorCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">errorCode</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="102-全局异常处理">10.2 全局异常处理
</h3><p><strong>Q: 全局异常是怎么处理的？</strong></p>
<p><strong>A:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestControllerAdvice</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GlobalExceptionHandler</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">BusinessException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">businessExceptionHandler</span><span class="p">(</span><span class="n">BusinessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;BusinessException&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResultUtils</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">RuntimeException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BaseResponse</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">runtimeExceptionHandler</span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;RuntimeException&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResultUtils</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">ErrorCode</span><span class="p">.</span><span class="na">SYSTEM_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;系统错误&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="十一技术栈选型">十一、技术栈选型
</h2><h3 id="111-核心版本">11.1 核心版本
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>技术</th>
          <th>版本</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Spring Boot</td>
          <td>3.5.4</td>
      </tr>
      <tr>
          <td>Java</td>
          <td>17/21</td>
      </tr>
      <tr>
          <td>MyBatis-Flex</td>
          <td>1.11.1</td>
      </tr>
      <tr>
          <td>Spring AI</td>
          <td>1.0.0-M7</td>
      </tr>
      <tr>
          <td>LangGraph4j</td>
          <td>1.6.0-rc2</td>
      </tr>
      <tr>
          <td>Caffeine</td>
          <td>3.1.8</td>
      </tr>
      <tr>
          <td>Jedis</td>
          <td>5.2.0</td>
      </tr>
  </tbody>
</table></div>
<h3 id="112-依赖选型原因">11.2 依赖选型原因
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>依赖</th>
          <th>选择原因</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Hutool</td>
          <td>全能工具库，减少重复代码</td>
      </tr>
      <tr>
          <td>Knife4j</td>
          <td>美观的API文档，支持调试</td>
      </tr>
      <tr>
          <td>Caffeine</td>
          <td>高性能本地缓存</td>
      </tr>
      <tr>
          <td>LangGraph4j</td>
          <td>Java版LangGraph，构建AI工作流</td>
      </tr>
      <tr>
          <td>HikariCP</td>
          <td>最快的JDBC连接池</td>
      </tr>
  </tbody>
</table></div>
<hr>
<h2 id="总结">总结
</h2><p>本文档覆盖了EduAgentX项目的核心技术细节，建议面试前：</p>
<ol>
<li><strong>重点掌握</strong>：Redis Lua脚本、多级缓存、Dubbo配置</li>
<li><strong>理解原理</strong>：HeavyKeeper算法、滑动窗口限流、异步落库</li>
<li><strong>熟悉代码</strong>：能够手写关键代码片段</li>
<li><strong>准备追问</strong>：每个技术点都要想好深入追问的答案</li>
</ol>
<p>祝面试顺利！🎉</p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 LuciusWan
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
